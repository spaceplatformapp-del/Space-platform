<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Space</title>

  <!-- PWA + iOS support -->

  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icons/icon-512.png">
  <meta name="theme-color" content="#0d1117">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Space">

  <style>
    :root{--bg:#ffffff;--card:#ffffff;--text:#0b1220;--muted:#6b7280;--accent:#2563eb}
    .dark{--bg:#0b1220;--card:#0f1724;--text:#f8fafc;--muted:#9ca3af;--accent:#3b82f6}
    html,body,#root{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:Inter,Segoe UI,Roboto,Helvetica,Arial}
    .container{max-width:960px;margin:0 auto;padding:16px}
    .card{background:var(--card);border-radius:8px;padding:12px;box-shadow:0 1px 4px rgba(2,6,23,0.06);margin-bottom:12px}
    .row{display:flex;gap:8px;align-items:center}
    .btn{background:var(--accent);color:#fff;padding:8px 12px;border-radius:6px;border:none;cursor:pointer}
    .btn-ghost{background:transparent;border:1px solid #ddd;padding:6px 10px;border-radius:6px;cursor:pointer;color:var(--text)}
    input,textarea,select{padding:8px;border:1px solid #e5e7eb;border-radius:6px;width:100%;background:transparent;color:var(--text)}
    textarea{min-height:80px;resize:vertical}
    .small{font-size:13px;color:var(--muted)}
    .avatar{width:48px;height:48px;border-radius:999px;object-fit:cover}
    .story{width:64px;height:64px;border-radius:999px;object-fit:cover;border:2px solid var(--accent);cursor:pointer}
    .hidden{display:none}
    .mt{margin-top:12px}
    .mb{margin-bottom:12px}
    .badge{background:#e6f0ff;color:#08306b;padding:4px 8px;border-radius:999px;font-size:12px;display:inline-block;margin-left:6px}
    .danger{background:#fee2e2;color:#7f1d1d}
    .flex{display:flex}
    .col{display:flex;flex-direction:column}
    .space-x{gap:8px}
    a{color:var(--accent);text-decoration:none}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px;flex-wrap:wrap}
    .search-input{width:280px}
    .post-media{max-width:100%;max-height:380px;border-radius:8px}
    .cover{height:160px;background:#ccc;border-radius:8px 8px 0 0;object-fit:cover;width:100%}
    .center{text-align:center}
    .splash{position:fixed;inset:0;background:var(--bg);display:flex;align-items:center;justify-content:center;z-index:9999;flex-direction:column}
    .splash .logo{font-size:48px;font-weight:800;margin-bottom:8px;background:linear-gradient(135deg,#667eea,#764ba2);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .msg-badge{position:absolute;top:-4px;right:-4px;background:#ef4444;color:#fff;border-radius:999px;width:18px;height:18px;font-size:11px;display:flex;align-items:center;justify-content:center;font-weight:700}
    .like-btn{cursor:pointer;user-select:none;display:inline-flex;align-items:center;gap:4px}
    .comment-box{margin-top:8px;padding-top:8px;border-top:1px solid #e5e7eb}
    @media (max-width:640px){.search-input{width:140px}}
    #space-diagnostics{position:fixed;left:8px;right:8px;top:8px;padding:10px;background:#ffeedd;border:2px solid #ff7a45;z-index:99999;font-family:Arial,Helvetica,sans-serif;display:none}
  </style>

  <!-- Firebase & Cloudinary Config -->

  <script>
    window.SPACE_CONFIG = {
      firebaseConfig: {
        apiKey: ""AIzaSyCa4goO5GkfV3P2xlxCGcBpbsbKf43zCrE",
        authDomain: "space-platform-app.firebaseapp.com",
        projectId: "space-platform-app",
        storageBucket: "space-platform-app.firebasestorage.app",
        messagingSenderId: "43015155483",
        appId: "43015155483:web:5a14764017a03001f3edbe"
};
      cloudinary: {
        cloudName: "drfvrs2yi",
        uploadPreset: "Spaceuploads"
      },
      ADMIN_EMAIL: "spaceplatformapp@gmail.com"
    };
  </script>
</head>
<body>
  <!-- Diagnostic box -->
  <div id="space-diagnostics">
    <b>Space â€” diagnostic</b>
    <div id="space-diagnostics-msg" style="margin-top:6px;font-size:13px;color:#333">Waiting...</div>
    <button id="space-diagnostics-clear" style="margin-top:8px;padding:6px 8px;border:none;background:#2563eb;color:white;border-radius:6px;cursor:pointer">Hide</button>
  </div>
  <script>
    (function(){
      const box = document.getElementById('space-diagnostics');
      const msg = document.getElementById('space-diagnostics-msg');
      const btn = document.getElementById('space-diagnostics-clear');
      btn.onclick = ()=> box.style.display='none';
      function showError(e){
        box.style.display = 'block';
        const text = (typeof e === 'string') ? e : (e && (e.message || e.stack || JSON.stringify(e))) || 'Unknown error';
        msg.innerText = text;
        console.error('Space diagnostic:', e);
      }
      window.addEventListener('error', (ev)=> { showError(ev.error || ev.message || 'Script error'); });
      window.addEventListener('unhandledrejection', (ev)=> { showError('Unhandled promise rejection: ' + (ev.reason && (ev.reason.message || ev.reason))); });
      window.SPACE_APP_OK = ()=> { box.style.display='block'; msg.innerText='App mounted successfully âœ”'; setTimeout(()=> box.style.display='none', 2200); };
      window.addEventListener('load', ()=>{
        const c = window.SPACE_CONFIG && window.SPACE_CONFIG.firebaseConfig;
        if (!c || !c.apiKey || c.apiKey.includes('YOUR_')) showError('Firebase config placeholders not replaced. Replace placeholders near top of index.html.');
        const cl = window.SPACE_CONFIG && window.SPACE_CONFIG.cloudinary;
        if (!cl || !cl.cloudName || !cl.uploadPreset) showError('Cloudinary config missing.');
      });
    })();
  </script>

  <!-- Splash screen -->

  <div id="splash" class="splash">
    <div class="logo">S</div>
    <div style="font-size:24px;font-weight:700;margin-top:8px">Space</div>
    <div class="small">Welcome â€” loading Spaceâ€¦</div>
  </div>

  <div id="root" class="container" style="visibility:hidden"></div>

  <!-- App code -->

  <script type="module">
  import React, { useEffect, useState, useRef } from 'https://cdn.jsdelivr.net/npm/react@18.2.0/+esm';
  import { createRoot } from 'https://cdn.jsdelivr.net/npm/react-dom@18.2.0/+esm';
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, sendEmailVerification, sendPasswordResetEmail, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
  import { getFirestore, collection, doc, setDoc, getDoc, addDoc, query, where, getDocs, orderBy, onSnapshot, updateDoc, deleteDoc, serverTimestamp, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
  import { getStorage } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js";

  const CONFIG = window.SPACE_CONFIG || {};
  const firebaseConfig = CONFIG.firebaseConfig || {};
  const CLOUDINARY_CLOUD = (CONFIG.cloudinary && CONFIG.cloudinary.cloudName) || "";
  const CLOUDINARY_UPLOAD_PRESET = (CONFIG.cloudinary && CONFIG.cloudinary.uploadPreset) || "";
  const ADMIN_EMAIL = CONFIG.ADMIN_EMAIL || "";

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);

  async function uploadToCloudinary(file) {
    if (!CLOUDINARY_CLOUD || !CLOUDINARY_UPLOAD_PRESET) throw new Error('Cloudinary not configured');
    const typeSegment = file.type.startsWith('video') ? 'video' : 'image';
    const url = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD}/${typeSegment}/upload`;
    const form = new FormData();
    form.append('file', file);
    form.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
    const res = await fetch(url, { method: 'POST', body: form });
    return res.json();
  }

  const usersDoc = (uid) => doc(db, 'users', uid);
  const postsCol = () => collection(db, 'posts');
  const storiesCol = () => collection(db, 'stories');
  const followsCol = () => collection(db, 'follows');
  const chatMessages = (chatId) => collection(db, `chats/${chatId}/messages`);

  async function createUserProfile(uid, profile) {
    await setDoc(usersDoc(uid), { ...profile, createdAt: serverTimestamp() });
  }
  async function getUserProfile(uid) {
    const d = await getDoc(usersDoc(uid));
    return d.exists() ? { id: d.id, ...d.data() } : null;
  }
  async function searchUsers(term) {
    if (!term || term.length < 2) return [];
    const q = query(collection(db, 'users'), where('displayNameLower', '>=', term.toLowerCase()), orderBy('displayNameLower'));
    const snap = await getDocs(q);
    return snap.docs.map(d => ({ id: d.id, ...d.data() }));
  }

  async function createPost(post) { return addDoc(postsCol(), { ...post, likes: [], comments: [], createdAt: serverTimestamp() }); }
  function subscribeFeed(cb) { const q = query(collection(db, 'posts'), orderBy('createdAt','desc')); return onSnapshot(q, snap => cb(snap.docs.map(d=>({ id: d.id, ...d.data() })))); }
  async function updatePost(postId, data) { return updateDoc(doc(db,'posts',postId), data); }
  async function deletePost(postId) { return deleteDoc(doc(db,'posts',postId)); }
  async function toggleLike(postId, uid) {
    const postRef = doc(db, 'posts', postId);
    const postSnap = await getDoc(postRef);
    if (!postSnap.exists()) return;
    const likes = postSnap.data().likes || [];
    if (likes.includes(uid)) {
      await updateDoc(postRef, { likes: arrayRemove(uid) });
    } else {
      await updateDoc(postRef, { likes: arrayUnion(uid) });
    }
  }
  async function addComment(postId, uid, text) {
    const postRef = doc(db, 'posts', postId);
    await updateDoc(postRef, { 
      comments: arrayUnion({ uid, text, createdAt: new Date().toISOString() }) 
    });
  }

  async function createStory(uid, mediaUrl, mediaType) { 
    const expiresAt = new Date(Date.now() + 24 * 60 * 60 * 1000);
    return addDoc(storiesCol(), { uid, mediaUrl, mediaType, createdAt: serverTimestamp(), expiresAt: expiresAt.toISOString() }); 
  }
  function subscribeStories(cb) { 
    const q = query(storiesCol(), orderBy('createdAt','desc')); 
    return onSnapshot(q, snap => {
      const now = new Date();
      const active = snap.docs.map(d=>({ id: d.id, ...d.data() })).filter(s => {
        if (!s.expiresAt) return true;
        return new Date(s.expiresAt) > now;
      });
      cb(active);
    }); 
  }

  async function followUser(fromUid, toUid) { 
    const id = `${fromUid}_${toUid}`; 
    await setDoc(doc(db, 'follows', id), { follower: fromUid, following: toUid, createdAt: serverTimestamp() }); 
  }
  async function addFriend(requester, target) { 
    const id = `${requester}_${target}`; 
    await setDoc(doc(db, 'friends', id), { requester, target, status: 'pending', createdAt: serverTimestamp() }); 
  }
  async function getFriends(uid) {
    const q = query(collection(db, 'friends'), where('status', '==', 'accepted'));
    const snap = await getDocs(q);
    return snap.docs.map(d => d.data()).filter(f => f.requester === uid || f.target === uid);
  }

  async function sendMessage(chatId, from, text, media=null) { 
    await addDoc(chatMessages(chatId), { from, text, media, read: false, createdAt: serverTimestamp() }); 
    await setDoc(doc(db, 'chats', chatId), { participants: chatId.split('_'), lastMessage: text, updatedAt: serverTimestamp() }, { merge: true });
  }
  function subscribeMessages(chatId, cb) { 
    const q = query(chatMessages(chatId), orderBy('createdAt','asc')); 
    return onSnapshot(q, snap => cb(snap.docs.map(d=>({ id: d.id, ...d.data() })))); 
  }
  async function getUnreadCount(uid) {
    const chatsSnap = await getDocs(query(collection(db, 'chats'), where('participants', 'array-contains', uid)));
    let count = 0;
    for (const chatDoc of chatsSnap.docs) {
      const msgsSnap = await getDocs(query(chatMessages(chatDoc.id), where('read', '==', false), where('from', '!=', uid)));
      count += msgsSnap.size;
    }
    return count;
  }

  function fmtDate(ts) {
    if (!ts) return '';
    try { 
      if (ts.seconds) return new Date(ts.seconds*1000).toLocaleString(); 
      return new Date(ts).toLocaleString(); 
    } catch { return ''; }
  }

  function App() {
    const [user, setUser] = useState(null);
    const [page, setPage] = useState('loading');
    const [feed, setFeed] = useState([]);
    const [stories, setStories] = useState([]);
    const [theme, setTheme] = useState(localStorage.getItem('theme') || 'light');
    const [lang, setLang] = useState(localStorage.getItem('lang') || 'en');
    const [searchTerm, setSearchTerm] = useState('');
    const [searchResults, setSearchResults] = useState([]);
    const [selectedProfile, setSelectedProfile] = useState(null);
    const [unreadMsgs, setUnreadMsgs] = useState(0);
    const [userProfile, setUserProfile] = useState(null);

    useEffect(()=> {
      const splash = document.getElementById('splash');
      onAuthStateChanged(auth, async (u) => {
        setUser(u);
        if (u) {
          const prof = await getUserProfile(u.uid);
          setUserProfile(prof);
          if (!prof) setPage('register'); 
          else {
            setPage('home');
            const count = await getUnreadCount(u.uid);
            setUnreadMsgs(count);
          }
        } else {
          setPage('login');
        }
      });
      const unsubFeed = subscribeFeed(setFeed);
      const unsubStories = subscribeStories(setStories);
      setTimeout(()=> {
        if (splash) splash.style.display = 'none';
        document.getElementById('root').style.visibility = 'visible';
      }, 700);
      return ()=> { unsubFeed(); unsubStories(); };
    }, []);

    useEffect(()=> { 
      document.documentElement.classList.toggle('dark', theme === 'dark'); 
      localStorage.setItem('theme', theme); 
    }, [theme]);
    
    useEffect(()=> { localStorage.setItem('lang', lang); }, [lang]);

    useEffect(()=> {
      const t = setTimeout(async ()=> {
        if (searchTerm.length >= 2) { 
          const r = await searchUsers(searchTerm); 
          setSearchResults(r); 
        } else setSearchResults([]);
      }, 300);
      return ()=> clearTimeout(t);
    }, [searchTerm]);

    return React.createElement('div', null,
      React.createElement(TopBar, { 
        user, 
        userProfile,
        onNav: setPage, 
        theme, 
        setTheme, 
        lang, 
        setLang, 
        searchTerm, 
        setSearchTerm, 
        searchResults, 
        unreadMsgs,
        onOpenProfile: uid => { setSelectedProfile(uid); setPage('profile'); } 
      }),
      React.createElement('div', { style: { minHeight: '60vh' } },
        page === 'loading' && React.createElement('div', { className: 'card' }, 'Loading...'),
        page === 'login' && React.createElement(LoginPage, { onSuccess: () => setPage('home') }),
        page === 'register' && React.createElement(RegisterPage, { onSuccess: () => setPage('home') }),
        page === 'home' && React.createElement(HomePage, { user, feed, stories }),
        page === 'profile' && React.createElement(ProfilePage, { uid: selectedProfile || (user && user.uid) }),
        page === 'settings' && React.createElement(SettingsPage, { lang, setLang }),
        page === 'messages' && React.createElement(MessagesPage, { currentUser: user, onMsgRead: () => setUnreadMsgs(0) }),
        page === 'admin' && React.createElement(AdminPage, null)
      ),
      React.createElement(Footer, null)
    );
  }

  function TopBar({ user, userProfile, onNav, theme, setTheme, lang, setLang, searchTerm, setSearchTerm, searchResults, unreadMsgs, onOpenProfile }) {
    return React.createElement('div', { className: 'topbar' },
      React.createElement('div', { className: 'row' },
        React.createElement('div', { style: { fontWeight:800, fontSize:24, background:'linear-gradient(135deg,#667eea,#764ba2)', WebkitBackgroundClip:'text', WebkitTextFillColor:'transparent' } }, 'S'),
        React.createElement('div', { style: { fontWeight:700, fontSize:20, marginLeft:4 } }, 'Space'),
        React.createElement('div', { className: 'card row', style: { position:'relative' } },
          React.createElement('input', { className: 'search-input', placeholder: 'Search friends...', value: searchTerm, onInput: e => setSearchTerm(e.target.value) }),
          (searchResults && searchResults.length > 0) && React.createElement('div', { className: 'card', style: { position:'absolute', marginTop:56, zIndex:20, maxHeight:200, overflow:'auto' } },
            searchResults.map(s => React.createElement('div', { key: s.id, style: { padding:'6px', cursor:'pointer' }, onClick: () => { onOpenProfile(s.id); setSearchTerm(''); } }, 
              s.displayName || s.email,
              s.verified && React.createElement('span', { className: 'badge' }, 'âœ”')
            ))
          )
        )
      ),
      React.createElement('div', { className: 'row' },
        React.createElement('select', { value: lang, onChange: e => setLang(e.target.value), className: 'small' },
          React.createElement('option', { value: 'en' }, 'EN'),
          React.createElement('option', { value: 'yo' }, 'YO'),
          React.createElement('option', { value: 'pt' }, 'PT')
        ),
        React.createElement('button', { className: 'btn-ghost', onClick: () => setTheme(theme === 'light' ? 'dark' : 'light') }, theme === 'light' ? 'ðŸŒž' : 'ðŸŒ™'),
        user ? React.createElement(React.Fragment, null,
          React.createElement('button', { className: 'btn', onClick: () => onNav('home') }, 'Home'),
          React.createElement('button', { className: 'btn-ghost', onClick: () => onNav('profile') }, 'Profile'),
          React.createElement('div', { style: { position:'relative' } },
            React.createElement('button', { className: 'btn-ghost', onClick: () => onNav('messages') }, 'ðŸ’¬'),
            unreadMsgs > 0 && React.createElement('span', { className: 'msg-badge' }, unreadMsgs)
          ),
          React.createElement('button', { className: 'btn-ghost', onClick: () => onNav('settings') }, 'Settings'),
          userProfile && userProfile.verified && React.createElement('button', { className: 'btn-ghost', onClick: () => onNav('admin') }, 'Admin'),
          React.createElement('button', { className: 'btn-ghost', onClick: async () => { await signOut(auth); window.location.reload(); } }, 'Logout')
        ) : React.createElement(React.Fragment, null,
          React.createElement('button', { className: 'btn', onClick: () => onNav('login') }, 'Login'),
          React.createElement('button', { className: 'btn-ghost', onClick: () => onNav('register') }, 'Sign up')
        )
      )
    );
  }

  function LoginPage({ onSuccess }) {
    const [email, setEmail] = useState('');
    const [password, setPassword] = useState('');
    const [msg, setMsg] = useState('');
    async function submit(e) {
      e && e.preventDefault();
      setMsg('');
      try { 
        await signInWithEmailAndPassword(auth, email, password); 
        onSuccess && onSuccess(); 
      } catch (err) { 
        console.error(err); 
        setMsg(err.message || 'Login failed'); 
      }
    }
    async function forgot() {
      if (!email) return alert('Enter your email then press Forgot password');
      try { 
        await sendPasswordResetEmail(auth, email); 
        alert('Reset email sent'); 
      } catch (err) { 
        alert(err.message || 'Failed'); 
      }
    }
    return React.createElement('div', { className: 'card' },
      React.createElement('h3', null, 'Login'),
      React.createElement('form', { onSubmit: submit, className: 'col' },
        React.createElement('input', { placeholder: 'Email', value: email, onInput: e => setEmail(e.target.value) }),
        React.createElement('input', { placeholder: 'Password', type: 'password', value: password, onInput: e => setPassword(e.target.value) }),
        React.createElement('div', { className: 'row' },
          React.createElement('button', { className: 'btn', type: 'submit' }, 'Login'),
          React.createElement('button', { type: 'button', className: 'btn-ghost', onClick: forgot }, 'Forgot password?')
        ),
        msg && React.createElement('div', { className: 'small danger' }, msg)
      )
    );
  }

  function RegisterPage({ onSuccess }) {
    const [form, setForm] = useState({ name:'', dob:'', gender:'', email:'', password:'' });
    const [error, setError] = useState('');
    async function submit(e) {
      e && e.preventDefault();
      setError('');
      try {
        const cred = await createUserWithEmailAndPassword(auth, form.email, form.password);
        const uid = cred.user.uid;
        const isAdmin = (form.email && form.email.toLowerCase() === (ADMIN_EMAIL || '').toLowerCase());
        await createUserProfile(uid, {
          displayName: form.name,
          displayNameLower: (form.name || '').toLowerCase(),
          dob: form.dob,
          gender: form.gender,
          email: form.email,
          avatarUrl: null,
          coverUrl: null,
          verified: isAdmin
        });
        if (ADMIN_EMAIL && form.email.toLowerCase() !== ADMIN_EMAIL.toLowerCase()) {
          try {
            const q = query(collection(db,'users'), where('email','==',ADMIN_EMAIL));
            const snap = await getDocs(q);
            if (!snap.empty) {
              const adminUid = snap.docs[0].id;
              await followUser(uid, adminUid);
            }
          } catch(e){}
        }
        try { await sendEmailVerification(cred.user); } catch(e){}
        alert('Registered. Verification email sent. Please verify your email.');
        onSuccess && onSuccess();
      } catch (err) { 
        console.error(err); 
        setError(err.message || 'Failed to register'); 
      }
    }
    return React.createElement('div', { className: 'card' },
      React.createElement('h3', null, 'Sign up'),
      React.createElement('form', { onSubmit: submit, className: 'col' },
        React.createElement('input', { placeholder: 'Full name', value: form.name, onInput: e => setForm({...form, name: e.target.value}), required: true }),
        React.createElement('label', { className: 'small' }, 'Date of birth'),
        React.createElement('input', { type: 'date', value: form.dob, onInput: e => setForm({...form, dob: e.target.value}), required: true }),
        React.createElement('select', { value: form.gender, onChange: e => setForm({...form, gender: e.target.value}), required: true },
          React.createElement('option', { value: '' }, 'Select gender'),
          React.createElement('option', { value: 'male' }, 'Male'),
          React.createElement('option', { value: 'female' }, 'Female'),
          React.createElement('option', { value: 'other' }, 'Other')
        ),
        React.createElement('input', { placeholder: 'Email', value: form.email, onInput: e => setForm({...form, email: e.target.value}), required: true }),
        React.createElement('input', { placeholder: 'Password', type: 'password', value: form.password, onInput: e => setForm({...form, password: e.target.value}), required: true }),
        React.createElement('div', { className: 'row' }, React.createElement('button', { className: 'btn', type: 'submit' }, 'Create account')),
        error && React.createElement('div', { className: 'small danger' }, error)
      )
    );
  }

  function HomePage({ user, feed, stories }) {
    return React.createElement('div', null,
      React.createElement('div', { className: 'card row' }, React.createElement('div', { style: { display:'flex', flexDirection:'column', flex:1 } }, React.createElement(Composer, null))),
      React.createElement('div', { className: 'card' },
        React.createElement('h4', null, 'Stories'),
        React.createElement('div', { className: 'row', style: { overflowX:'auto' } },
          React.createElement(StoryComposer, null),
          stories.map(s => React.createElement('div', { key: s.id, style: { marginLeft:8 } }, React.createElement('img', { src: s.mediaUrl, className: 'story', onClick: () => window.open(s.mediaUrl, '_blank') })))
        )
      ),
      React.createElement('div', null, feed.map(p => React.createElement(PostCard, { key: p.id, post: p, currentUser: user })))
    );
  }

  function Composer() {
    const [text, setText] = useState('');
    const [file, setFile] = useState(null);
    const [loading, setLoading] = useState(false);
    const me = auth.currentUser;
    async function submit(e) {
      e && e.preventDefault();
      if (!me) return alert('Login first');
      setLoading(true);
      try {
        let media = null;
        if (file) {
          const res = await uploadToCloudinary(file);
          media = { url: res.secure_url, type: res.resource_type || 'image' };
        }
        await createPost({ authorId: me.uid, content: text, media, likes: [], comments: [], createdAt: serverTimestamp() });
        setText(''); setFile(null);
      } catch (err) { console.error(err); alert('Failed to post'); } finally { setLoading(false); }
    }
    return React.createElement('form', { onSubmit: submit, className: 'col' },
      React.createElement('textarea', { placeholder: "What's happening?", value: text, onInput: e => setText(e.target.value) }),
      React.createElement('input', { type: 'file', accept: 'image/*,video/*', onChange: e => setFile(e.target.files[0]) }),
      React.createElement('div', { className: 'row' }, React.createElement('button', { className: 'btn', type: 'submit', disabled: loading }, loading ? 'Posting...' : 'Post'))
    );
  }

  function StoryComposer() {
    const [file, setFile] = useState(null);
    const [loading, setLoading] = useState(false);
    const me = auth.currentUser;
    async function submit(e) {
      e && e.preventDefault();
      if (!me) return alert('Login to add a story');
      if (!file) return alert('Pick a file');
      setLoading(true);
      try {
        const res = await uploadToCloudinary(file);
        await createStory(me.uid, res.secure_url, res.resource_type || 'image');
        setFile(null);
      } catch (err) { console.error(err); alert('Story upload failed'); } finally { setLoading(false); }
    }
    return React.createElement('form', { onSubmit: submit, className: 'col', style: { minWidth:120 } },
      React.createElement('input', { type: 'file', accept: 'image/*,video/*', onChange: e => setFile(e.target.files[0]) }),
      React.createElement('button', { className: 'btn-ghost', type: 'submit', disabled: loading }, loading ? 'Uploading...' : 'Add Story')
    );
  }

  function PostCard({ post, currentUser }) {
    const me = currentUser;
    const isMine = me && me.uid === post.authorId;
    const [editing, setEditing] = useState(false);
    const [text, setText] = useState(post.content || '');
    const [showComments, setShowComments] = useState(false);
    const [commentText, setCommentText] = useState('');
    const [authorProfile, setAuthorProfile] = useState(null);
    const liked = me && post.likes && post.likes.includes(me.uid);

    useEffect(() => {
      (async () => {
        if (post.authorId) {
          const prof = await getUserProfile(post.authorId);
          setAuthorProfile(prof);
        }
      })();
    }, [post.authorId]);

    async function save() { 
      try { 
        await updatePost(post.id, { content: text }); 
        setEditing(false); 
      } catch (err) { 
        alert('Failed'); 
      } 
    }
    
    async function remove() { 
      if (!confirm('Delete post?')) return; 
      try { 
        await deletePost(post.id); 
      } catch (e) { 
        alert('Failed to delete'); 
      } 
    }

    async function handleLike() {
      if (!me) return alert('Login to like');
      try {
        await toggleLike(post.id, me.uid);
      } catch (err) {
        console.error(err);
      }
    }

    async function submitComment() {
      if (!me) return alert('Login to comment');
      if (!commentText.trim()) return;
      try {
        await addComment(post.id, me.uid, commentText);
        setCommentText('');
      } catch (err) {
        console.error(err);
        alert('Failed to add comment');
      }
    }

    return React.createElement('div', { className: 'card' },
      React.createElement('div', { className: 'row', style: { justifyContent:'space-between' } },
        React.createElement('div', { className: 'row' },
          authorProfile && authorProfile.avatarUrl && React.createElement('img', { src: authorProfile.avatarUrl, className: 'avatar', style: { width:32, height:32 } }),
          React.createElement('div', null, 
            React.createElement('strong', null, authorProfile ? authorProfile.displayName : post.authorId),
            authorProfile && authorProfile.verified && React.createElement('span', { className: 'badge' }, 'âœ”'),
            React.createElement('div', { className: 'small' }, fmtDate(post.createdAt))
          )
        ),
        isMine && React.createElement('div', { className: 'row space-x' }, 
          React.createElement('button', { className: 'btn-ghost', onClick: () => setEditing(!editing) }, 'Edit'), 
          React.createElement('button', { className: 'btn-ghost danger', onClick: remove }, 'Delete')
        )
      ),
      editing ? React.createElement('div', { className: 'mt' }, 
        React.createElement('textarea', { value: text, onInput: e => setText(e.target.value) }), 
        React.createElement('button', { className: 'btn', onClick: save }, 'Save')
      ) : React.createElement('div', null, 
        React.createElement('p', null, post.content), 
        post.media && React.createElement('div', null, 
          post.media.type && post.media.type.startsWith('video') ? 
            React.createElement('video', { src: post.media.url, controls: true, className: 'post-media' }) : 
            React.createElement('img', { src: post.media.url, className: 'post-media' })
        ),
        React.createElement('div', { className: 'row mt', style: { gap: 16 } },
          React.createElement('div', { className: 'like-btn', onClick: handleLike },
            React.createElement('span', null, liked ? 'â¤ï¸' : 'ðŸ¤'),
            React.createElement('span', { className: 'small' }, (post.likes && post.likes.length) || 0)
          ),
          React.createElement('div', { className: 'like-btn', onClick: () => setShowComments(!showComments) },
            React.createElement('span', null, 'ðŸ’¬'),
            React.createElement('span', { className: 'small' }, (post.comments && post.comments.length) || 0)
          )
        ),
        showComments && React.createElement('div', { className: 'comment-box' },
          post.comments && post.comments.map((c, i) => React.createElement('div', { key: i, style: { marginBottom: 8, padding: 8, background: 'var(--card)', borderRadius: 6 } },
            React.createElement('div', { className: 'small' }, React.createElement('strong', null, c.uid)),
            React.createElement('div', null, c.text)
          )),
          React.createElement('div', { className: 'row mt' },
            React.createElement('input', { placeholder: 'Write a comment...', value: commentText, onInput: e => setCommentText(e.target.value) }),
            React.createElement('button', { className: 'btn', onClick: submitComment }, 'Post')
          )
        )
      )
    );
  }

  function ProfilePage({ uid }) {
    const [profile, setProfile] = useState(null);
    const [editing, setEditing] = useState(false);
    const [name, setName] = useState('');
    const [avatarFile, setAvatarFile] = useState(null);
    const [coverFile, setCoverFile] = useState(null);
    const [friends, setFriends] = useState([]);
    const me = auth.currentUser;
    const owner = !uid || (me && uid === me.uid);
    const viewUid = uid || (me && me.uid);

    useEffect(()=> {
      if (!viewUid) return;
      let mounted = true;
      (async ()=> {
        const p = await getUserProfile(viewUid);
        if (mounted) { 
          setProfile(p); 
          setName(p?.displayName || ''); 
        }
        const friendsList = await getFriends(viewUid);
        if (mounted) setFriends(friendsList);
      })();
      return ()=> mounted = false;
    }, [viewUid]);

    async function save() {
      if (!viewUid) return;
      try {
        let avatarUrl = profile?.avatarUrl || null;
        let coverUrl = profile?.coverUrl || null;
        
        if (avatarFile) {
          const r = await uploadToCloudinary(avatarFile);
          avatarUrl = r.secure_url;
        }
        if (coverFile) {
          const r = await uploadToCloudinary(coverFile);
          coverUrl = r.secure_url;
        }
        
        await updateDoc(doc(db, 'users', viewUid), { 
          displayName: name, 
          displayNameLower: name.toLowerCase(),
          avatarUrl,
          coverUrl 
        });
        const p = await getUserProfile(viewUid);
        setProfile(p);
        setEditing(false);
        setAvatarFile(null);
        setCoverFile(null);
      } catch (err) { 
        console.error(err); 
        alert('Failed'); 
      }
    }

    async function follow() { 
      if (!me) return alert('Login'); 
      try { 
        await followUser(me.uid, viewUid); 
        alert('Followed'); 
      } catch(e){ 
        alert('Failed to follow'); 
      } 
    }
    
    async function addFr() { 
      if (!me) return alert('Login'); 
      try { 
        await addFriend(me.uid, viewUid); 
        alert('Friend request sent'); 
      } catch(e){ 
        alert('Failed'); 
      } 
    }

    if (!profile) return React.createElement('div', { className: 'card' }, 'Loading...');
    
    return React.createElement('div', null,
      React.createElement('div', { className: 'card' },
        profile.coverUrl ? 
          React.createElement('img', { src: profile.coverUrl, alt: 'cover', className: 'cover' }) :
          React.createElement('div', { className: 'cover', style: { background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' } }),
        React.createElement('div', { style: { marginTop:-40, display:'flex', alignItems:'center', gap:12, flexWrap:'wrap' } },
          React.createElement('img', { src: profile.avatarUrl || 'https://via.placeholder.com/150', className: 'avatar', style: { border:'4px solid var(--bg)' } }),
          React.createElement('div', null, 
            React.createElement('div', { style: { fontSize:18, fontWeight:600 } }, profile.displayName),
            React.createElement('div', { className: 'small' }, 
              profile.email,
              profile.verified && React.createElement('span', { className: 'badge' }, 'âœ” Verified')
            )
          ),
          React.createElement('div', { style: { marginLeft:'auto' }, className: 'row' },
            !owner && React.createElement('button', { className: 'btn', onClick: follow }, 'Follow'),
            !owner && React.createElement('button', { className: 'btn-ghost', onClick: addFr }, 'Add Friend'),
            owner && React.createElement('button', { className: 'btn-ghost', onClick: () => setEditing(!editing) }, editing ? 'Cancel' : 'Edit profile')
          )
        ),
        editing && React.createElement('div', { className: 'mt col' },
          React.createElement('label', { className: 'small' }, 'Display name'),
          React.createElement('input', { placeholder: 'Display name', value: name, onInput: e => setName(e.target.value) }),
          React.createElement('label', { className: 'small mt' }, 'Profile picture'),
          React.createElement('input', { type: 'file', accept: 'image/*', onChange: e => setAvatarFile(e.target.files[0]) }),
          React.createElement('label', { className: 'small mt' }, 'Cover photo'),
          React.createElement('input', { type: 'file', accept: 'image/*', onChange: e => setCoverFile(e.target.files[0]) }),
          React.createElement('div', { className: 'row mt' }, React.createElement('button', { className: 'btn', onClick: save }, 'Save changes'))
        ),
        React.createElement('div', { className: 'mt' },
          React.createElement('h4', null, 'Friends (', friends.length, ')'),
          friends.length === 0 && React.createElement('div', { className: 'small' }, 'No friends yet')
        )
      )
    );
  }

  function MessagesPage({ currentUser, onMsgRead }) {
    const [chats, setChats] = useState([]);
    const [chatId, setChatId] = useState('');
    const [msgs, setMsgs] = useState([]);
    const [text, setText] = useState('');
    const [file, setFile] = useState(null);
    const messagesEndRef = useRef(null);

    useEffect(() => {
      if (!currentUser) return;
      const q = query(collection(db, 'chats'), where('participants', 'array-contains', currentUser.uid), orderBy('updatedAt', 'desc'));
      const unsub = onSnapshot(q, snap => {
        setChats(snap.docs.map(d => ({ id: d.id, ...d.data() })));
      });
      return () => unsub();
    }, [currentUser]);

    useEffect(()=> {
      if (!chatId) return;
      const unsub = subscribeMessages(chatId, setMsgs);
      if (onMsgRead) onMsgRead();
      return ()=> unsub();
    }, [chatId]);

    useEffect(() => {
      messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
    }, [msgs]);

    async function openChatWith() {
      const other = prompt('Enter other user UID to chat with');
      if (!other) return;
      const id = [currentUser.uid, other].sort().join('_');
      try { 
        await setDoc(doc(db,'chats',id), { 
          participants: [currentUser.uid, other], 
          updatedAt: serverTimestamp() 
        }, { merge: true }); 
      } catch(e){}
      setChatId(id);
    }

    async function send() {
      if (!chatId) return alert('Open a chat first');
      let media = null;
      if (file) {
        try { 
          const r = await uploadToCloudinary(file); 
          media = { url: r.secure_url, type: r.resource_type || 'image' }; 
        } catch(e){ 
          console.error(e); 
          alert('Upload failed'); 
          return; 
        }
      }
      if (!text && !media) return;
      await sendMessage(chatId, currentUser.uid, text, media);
      setText(''); 
      setFile(null);
    }

    return React.createElement('div', { className: 'card' },
      React.createElement('h3', null, 'Messages'),
      React.createElement('div', { className: 'row', style: { gap: 12 } },
        React.createElement('div', { style: { width: 200, borderRight: '1px solid #e5e7eb', paddingRight: 12 } },
          React.createElement('button', { className: 'btn mb', onClick: openChatWith }, 'New Chat'),
          chats.map(c => React.createElement('div', { 
            key: c.id, 
            className: 'card', 
            style: { 
              cursor: 'pointer', 
              background: chatId === c.id ? 'var(--accent)' : 'var(--card)',
              color: chatId === c.id ? '#fff' : 'var(--text)'
            },
            onClick: () => setChatId(c.id) 
          },
            React.createElement('div', { className: 'small' }, c.participants.filter(p => p !== currentUser.uid)[0] || 'Unknown'),
            React.createElement('div', { className: 'small', style: { fontSize: 11 } }, c.lastMessage || 'No messages')
          ))
        ),
        React.createElement('div', { style: { flex: 1 } },
          !chatId && React.createElement('div', { className: 'center small' }, 'Select a chat or start a new one'),
          chatId && React.createElement('div', null,
            React.createElement('div', { className: 'card', style: { height:400, overflow:'auto', marginBottom: 12 } }, 
              msgs.map(m => React.createElement('div', { 
                key: m.id, 
                style: { 
                  padding:'8px 12px', 
                  background: m.from === currentUser.uid ? '#dbeafe' : '#f3f4f6', 
                  borderRadius:12, 
                  marginBottom:8,
                  maxWidth: '70%',
                  marginLeft: m.from === currentUser.uid ? 'auto' : 0,
                  marginRight: m.from === currentUser.uid ? 0 : 'auto'
                } 
              },
                React.createElement('div', { className: 'small', style: { fontWeight: 600, marginBottom: 4 } }, 
                  m.from === currentUser.uid ? 'You' : m.from
                ),
                React.createElement('div', null, m.text),
                m.media && React.createElement('div', { style: { marginTop: 8 } }, 
                  m.media.type && m.media.type.startsWith('video') ? 
                    React.createElement('video', { src: m.media.url, controls: true, style: { maxWidth: '100%', borderRadius: 8 } }) : 
                    React.createElement('img', { src: m.media.url, style: { maxWidth: '100%', borderRadius: 8 } })
                ),
                React.createElement('div', { className: 'small', style: { fontSize: 10, marginTop: 4, opacity: 0.7 } }, 
                  fmtDate(m.createdAt)
                )
              )),
              React.createElement('div', { ref: messagesEndRef })
            ),
            React.createElement('div', { className: 'row' },
              React.createElement('input', { placeholder: 'Type a message', value: text, onInput: e => setText(e.target.value), onKeyPress: e => e.key === 'Enter' && send() }),
              React.createElement('input', { type: 'file', accept: 'image/*,video/*', onChange: e => setFile(e.target.files[0]), style: { width: 'auto' } }),
              React.createElement('button', { className: 'btn', onClick: send }, 'Send')
            )
          )
        )
      )
    );
  }

  function SettingsPage({ lang, setLang }) {
    return React.createElement('div', { className: 'card' },
      React.createElement('h3', null, 'Settings'),
      React.createElement('div', { className: 'col' },
        React.createElement('label', { className: 'small' }, 'Language'),
        React.createElement('select', { value: lang, onChange: e => setLang(e.target.value) }, 
          React.createElement('option', { value: 'en' }, 'English'), 
          React.createElement('option', { value: 'yo' }, 'Yoruba'), 
          React.createElement('option', { value: 'pt' }, 'Portuguese')
        ),
        React.createElement('div', { className: 'mt' }, 
          React.createElement('h4', null, 'Help & Support'), 
          React.createElement('p', { className: 'small' }, 'If you need help, contact support at: ', React.createElement('a', { href: 'mailto:myspacesocialapp@gmail.com' }, 'myspacesocialapp@gmail.com'))
        )
      )
    );
  }

  function AdminPage() {
    const [users, setUsers] = useState([]);
    const [loading, setLoading] = useState(true);
    
    useEffect(()=> {
      (async ()=> {
        try {
          const q = query(collection(db,'users'), orderBy('createdAt','desc'));
          const snap = await getDocs(q);
          setUsers(snap.docs.map(d=>({ id: d.id, ...d.data() })));
        } catch (err) {
          console.error(err);
          alert('Failed to load users');
        } finally {
          setLoading(false);
        }
      })();
    }, []);
    
    async function toggleVerified(uid, current) {
      try {
        await updateDoc(doc(db,'users',uid), { verified: !current });
        const p = await getUserProfile(uid);
        setUsers(u => u.map(x => x.id === uid ? p : x));
      } catch (err) {
        console.error(err);
        alert('Failed to update verification');
      }
    }
    
    return React.createElement('div', { className: 'card' },
      React.createElement('h3', null, 'Admin Panel'),
      React.createElement('p', { className: 'small mb' }, 'Manage user verification badges'),
      loading ? React.createElement('div', null, 'Loading users...') : 
        users.map(u => React.createElement('div', { key: u.id, className: 'row', style: { justifyContent:'space-between', marginBottom:12, padding: 8, background: 'var(--card)', borderRadius: 6 } }, 
          React.createElement('div', { className: 'row' },
            u.avatarUrl && React.createElement('img', { src: u.avatarUrl, className: 'avatar', style: { width: 32, height: 32 } }),
            React.createElement('div', null, 
              React.createElement('strong', null, u.displayName),
              u.verified && React.createElement('span', { className: 'badge' }, 'âœ”'),
              React.createElement('div', { className: 'small' }, u.email)
            )
          ), 
          React.createElement('button', { className: u.verified ? 'btn-ghost danger' : 'btn', onClick: () => toggleVerified(u.id, u.verified) }, 
            u.verified ? 'Remove Verification' : 'Verify User'
          )
        ))
    );
  }

  function Footer() {
    return React.createElement('div', { className: 'center small mt', style: { paddingTop: 24, paddingBottom: 24, borderTop: '1px solid #e5e7eb' } }, 
      React.createElement('div', null, 'Â© 2025 Space â€¢ Social Media PWA'),
      React.createElement('div', { style: { marginTop: 4 } }, 'Replace Firebase & Cloudinary credentials before deployment')
    );
  }

  const container = document.getElementById('root');
  createRoot(container).render(React.createElement(App));
  if (window.SPACE_APP_OK) window.SPACE_APP_OK();

  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/sw.js').then(() => console.log('Service Worker registered')).catch((err) => console.log('Service Worker failed', err));
    });
  }
  </script>

</body>
</html>
