<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Space</title>
  <!-- This file is now required -->
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icons/icon-512.png">
  <meta name="theme-color" content="#6366f1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Space">

  <style>
    :root{
      --bg:#f0f2f5;--card:#ffffff;--text:#050505;--muted:#65676b;
      --primary:#1b74e4;--secondary:#e4405f;--accent:#8b5cf6;
      --gradient:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      --hover:#f2f3f5;
    }
    .dark{
      --bg:#18191a;--card:#242526;--text:#e4e6eb;--muted:#b0b3b8;
      --primary:#2d88ff;--secondary:#ff6b9d;--hover:#3a3b3c;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body,#root{height:100%;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text)}
    .container{max-width:680px;margin:0 auto;padding:12px 12px 80px;height:calc(100% - 120px)}
    .card{background:var(--card);border-radius:8px;padding:16px;box-shadow:0 1px 2px rgba(0,0,0,0.2);margin-bottom:12px}
    .card-lg{padding:20px}
    .row{display:flex;gap:12px;align-items:center}
    .col{display:flex;flex-direction:column;gap:12px}
    .btn{background:var(--primary);color:#fff;padding:10px 24px;border-radius:6px;border:none;cursor:pointer;font-weight:600;font-size:15px}
    .btn:hover{opacity:0.9}
    .btn:disabled{background:var(--muted);cursor:not-allowed}
    .btn-secondary{background:var(--hover);color:var(--text)}
    .btn-ghost{background:var(--hover);color:var(--text);padding:8px 16px;border-radius:6px;cursor:pointer;border:none;font-weight:600}
    input,textarea,select{padding:12px;border:1px solid #ccd0d5;border-radius:6px;width:100%;background:var(--card);color:var(--text);font-size:15px}
    input:focus,textarea:focus{outline:none;border-color:var(--primary)}
    textarea{min-height:80px;resize:vertical;font-family:inherit}
    .small{font-size:13px;color:var(--muted)}
    .avatar{width:40px;height:40px;border-radius:50%;object-fit:cover}
    .avatar-lg{width:48px;height:48px}
    .story-circle{width:110px;min-width:110px;height:150px;border-radius:12px;overflow:hidden;cursor:pointer;position:relative;border:3px solid var(--card);box-shadow:0 2px 4px rgba(0,0,0,0.1)}
    .story-circle img{width:100%;height:100%;object-fit:cover}
    .story-avatar{position:absolute;top:8px;left:8px;width:40px;height:40px;border-radius:50%;border:4px solid var(--primary)}
    .story-label{position:absolute;bottom:8px;left:8px;right:8px;color:#fff;font-weight:600;font-size:13px;text-shadow:0 1px 2px rgba(0,0,0,0.5)}
    .badge{background:var(--gradient);color:#fff;padding:4px 10px;border-radius:12px;font-size:11px;font-weight:600;margin-left:6px}
    .followers-badge{background:var(--hover);color:var(--muted);padding:4px 10px;border-radius:12px;font-size:11px;font-weight:600;margin-left:8px}
    .notif-badge{position:absolute;top:-4px;right:-4px;background:#fa3e3e;color:#fff;border-radius:50%;min-width:20px;height:20px;padding:0 6px;font-size:12px;display:flex;align-items:center;justify-content:center;font-weight:700;border:2px solid var(--card)}
    .post-media{width:100%;max-height:600px;border-radius:8px;margin-top:12px;object-fit:cover}
    .cover{height:200px;background:var(--hover);border-radius:8px 8px 0 0;object-fit:cover;width:100%}
    .avatar-placeholder{
      width:80px;height:80px;border:'5px solid var(--card)';cursor:pointer;border-radius:50%;
      background: var(--hover); display:flex; align-items:center; justify-content:center;
      font-size: 40px; color: var(--muted); border: 5px solid var(--card);
    }
    .splash{position:fixed;inset:0;background:var(--bg);display:flex;align-items:center;justify-content:center;z-index:9999;flex-direction:column}
    .splash .logo{font-size:72px;font-weight:900;background:var(--gradient);-webkit-background-clip:text;-webkit-text-fill-color:transparent;animation:pulse 2s infinite}
    @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
    .topbar{position:sticky;top:0;background:var(--card);border-bottom:1px solid #ccd0d5;padding:8px 16px;display:flex;align-items:center;gap:12px;z-index:100;box-shadow:0 2px 4px rgba(0,0,0,0.1)}
    .topbar-logo{font-size:32px;font-weight:900;background:var(--gradient);-webkit-background-clip:text;-webkit-text-fill-color:transparent;cursor:pointer;width:40px}
    .search-box{flex:1;max-width:240px;position:relative}
    .search-input{padding:10px 16px;border-radius:50px;background:var(--hover);border:none;font-size:15px}
    .search-results{position:absolute;top:100%;left:0;right:0;background:var(--card);border-radius:8px;margin-top:8px;box-shadow:0 4px 12px rgba(0,0,0,0.15);max-height:400px;overflow-y:auto;z-index:200}
    .search-item{padding:12px;cursor:pointer;border-bottom:1px solid var(--hover)}
    .search-item:hover{background:var(--hover)}
    .topbar-icons{display:flex;gap:8px;margin-left:auto}
    .icon-btn{width:40px;height:40px;border-radius:50%;background:var(--hover);display:flex;align-items:center;justify-content:center;cursor:pointer;position:relative;font-size:20px}
    .icon-btn:hover{background:#e4e6eb}
    .dark .icon-btn:hover{background:#4a4b4d}
    .bottomnav{position:fixed;bottom:0;left:0;right:0;background:var(--card);border-top:1px solid #ccd0d5;display:flex;justify-content:space-around;padding:6px 0;z-index:100;box-shadow:0 -2px 4px rgba(0,0,0,0.1)}
    .nav-item{flex:1;display:flex;flex-direction:column;align-items:center;gap:2px;cursor:pointer;padding:8px;border-radius:8px;margin:0 4px;position:relative}
    .nav-item:hover{background:var(--hover)}
    .nav-item.active{color:var(--primary)}
    .nav-item.active .nav-icon{border-bottom:3px solid var(--primary)}
    .nav-icon{font-size:24px;padding:4px 0}
    .nav-label{font-size:12px;font-weight:500}
    .nav-item .notif-badge{top:0px;right:15px;min-width:18px;height:18px;font-size:11px}
    .composer-trigger{background:var(--hover);padding:12px 16px;border-radius:50px;color:var(--muted);cursor:pointer;width:100%;text-align:left;border:none;font-size:15px}
    .composer-trigger:hover{background:#e4e6eb}
    .dark .composer-trigger:hover{background:#3a3b3c}
    .like-btn{display:inline-flex;align-items:center;gap:8px;cursor:pointer;padding:8px 12px;border-radius:6px;transition:all 0.2s;font-weight:600;color:var(--muted)}
    .like-btn:hover{background:var(--hover)}
    .like-btn.liked{color:#e4405f}
    .comment-section{margin-top:12px;padding-top:12px;border-top:1px solid var(--hover)}
    .comment-item{background:var(--hover);padding:10px 12px;border-radius:16px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:flex-start}
    .comment-author{font-weight:600;font-size:13px;margin-bottom:4px;cursor:pointer}
    .comment-author:hover{text-decoration:underline}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:9999;padding:20px}
    .modal-content{background:var(--card);border-radius:12px;padding:24px;max-width:500px;width:100%;max-height:90vh;overflow-y:auto;box-shadow:0 8px 24px rgba(0,0,0,0.3)}
    .tabs{display:flex;border-bottom:1px solid var(--hover);margin-bottom:16px}
    .tab{padding:14px 20px;cursor:pointer;color:var(--muted);font-weight:600;border-bottom:3px solid transparent;flex:1;text-align:center}
    .tab.active{color:var(--primary);border-bottom-color:var(--primary)}
    .friend-card{display:flex;align-items:center;justify-content:space-between;padding:12px;background:var(--card);border-radius:8px;margin-bottom:8px}
    .friend-item-card{display:flex;align-items:center;gap:12px;padding:12px;border-radius:8px;cursor:pointer;position:relative}
    .friend-item-card:hover{background:var(--hover)}
    .friend-item-card .notif-badge{top:8px;right:8px;position:static;margin-left:auto}
    .empty-state{text-align:center;padding:60px 20px;color:var(--muted)}
    .empty-icon{font-size:64px;margin-bottom:16px;opacity:0.5}
    /* Chat Page Styles */
    .chat-page{display:flex;flex-direction:column;height:100%;padding:0;background-size:cover;background-position:center}
    .chat-header{display:flex;align-items:center;gap:12px;padding:12px;border-bottom:1px solid var(--hover);flex-shrink:0;background:var(--card);position:relative}
    .chat-messages{flex:1;overflow-y:auto;padding:12px;display:flex;flex-direction:column-reverse}
    .chat-message-item{display:flex;margin-bottom:8px;max-width:75%;}
    .chat-bubble{padding:10px 14px;border-radius:18px;line-height:1.4;word-break:break-word}
    .chat-bubble img{width:100%;max-width:250px;border-radius:12px;margin-top:8px}
    .chat-message-item.sent{margin-left:auto}
    .chat-message-item.sent .chat-bubble{background:var(--primary);color:#fff;cursor:pointer}
    .chat-message-item.received .chat-bubble{background:var(--hover);color:var(--text)}
    .chat-input-box{display:flex;gap:8px;padding:12px;border-top:1px solid var(--hover);flex-shrink:0;background:var(--card)}
    .chat-menu{position:absolute;top:100%;right:12px;background:var(--card);border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.15);padding:8px;z-index:10}
    .chat-menu-item{padding:10px 16px;cursor:pointer;border-radius:6px;font-size:14px}
    .chat-menu-item:hover{background:var(--hover)}
    .chat-menu-item.danger{color:#fa3e3e}
    .chat-menu-item.danger:hover{background:rgba(250, 62, 62, 0.1)}
    /* End Chat Page Styles */
    
    .install-banner {
      position: fixed;
      bottom: 70px;
      left: 12px;
      right: 12px;
      background: var(--card);
      padding: 16px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    .install-banner-text {
      font-weight: 600;
      font-size: 15px;
    }
    .install-banner-buttons {
      display: flex;
      gap: 8px;
      flex-shrink: 0;
    }
    .install-banner-buttons .btn-ghost {
      padding: 8px 12px;
    }
    .install-banner-buttons .btn {
      padding: 8px 16px;
    }

    #space-diagnostics{position:fixed;left:8px;right:8px;top:8px;padding:12px;background:#fff3cd;border:2px solid #ffc107;border-radius:8px;z-index:99999;display:none;box-shadow:0 4px 12px rgba(0,0,0,0.15)}
  </style>

  <script>
  window.SPACE_CONFIG = {
    firebaseConfig: {
      apiKey: "AIzaSyCa4goO5GkfV3P2xlxCGcBpbsbKf43zCrE",
      authDomain: "space-platform-app.firebaseapp.com",
      projectId: "space-platform-app",
      storageBucket: "space-platform-app.firebasestorage.app",
      messagingSenderId: "43015155483",
      appId: "43015155483:web:5a14764017a03001f3edbe"
    },
    cloudinary: {
      cloudName: "drfvrs2yi",
      uploadPreset: "Spaceuploads"
    },
    ADMIN_EMAIL: "spaceplatformapp@gmail.com"
  };
  </script>

</head>
<body>
  <div id="space-diagnostics">
    <b>‚ö†Ô∏è Space Diagnostic</b>
    <div id="space-diagnostics-msg" style="margin-top:8px;font-size:13px"></div>
    <button id="space-diagnostics-clear" style="margin-top:8px;padding:6px 12px;border:none;background:#1b74e4;color:white;border-radius:6px;cursor:pointer">Hide</button>
  </div>
  <script>
    (function(){
      const box = document.getElementById('space-diagnostics');
      const msg = document.getElementById('space-diagnostics-msg');
      const btn = document.getElementById('space-diagnostics-clear');
      btn.onclick = ()=> box.style.display='none';
      function showError(e){
        box.style.display = 'block';
        const text = (typeof e === 'string') ? e : (e && (e.message || e.stack)) || 'Unknown error';
        msg.innerText = text;
        console.error('Space diagnostic:', e);
      }
      window.addEventListener('error', (ev)=> { showError(ev.error || ev.message); });
      window.addEventListener('unhandledrejection', (ev)=> { showError('Promise rejection: ' + (ev.reason?.message || ev.reason)); });
      window.SPACE_APP_OK = ()=> { box.style.display='block'; msg.innerText='‚úÖ App loaded!'; setTimeout(()=> box.style.display='none', 2000); };
    })();
  </script>

  <div id="splash" class="splash">
    <div class="logo">S</div>
    <div style="font-size:28px;font-weight:700;margin-top:12px">Space</div>
    <div class="small" style="margin-top:8px">Loading...</div>
  </div>

  <div id="root" style="visibility:hidden"></div>

  <script type="module">
  import React, { useEffect, useState, useRef } from 'https://cdn.jsdelivr.net/npm/react@18.2.0/+esm';
  import { createRoot } from 'https://cdn.jsdelivr.net/npm/react-dom@18.2.0/+esm';
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, sendEmailVerification, sendPasswordResetEmail, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
  import { getFirestore, collection, doc, setDoc, getDoc, addDoc, query, where, getDocs, orderBy, onSnapshot, updateDoc, deleteDoc, serverTimestamp, arrayUnion, arrayRemove, limit, increment, runTransaction } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
  import { getStorage } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js";

// --- START I18N (Translations) ---
  const translations = {
    en: {// ... after messageFailed: '...'
      close: 'Close',
      games: 'Games', // ADD THIS
      gameLobby: 'Game Lobby', // ADD THIS
      createGame: 'Create New Game', // ADD THIS
      creating: 'Creating...', // ADD THIS
      openGames: 'Open Games', // ADD THIS
      noOpenGames: 'No open games. Create one!', // ADD THIS
      gameBy: 'Game by {name}', // ADD THIS
      join: 'Join', // ADD THIS
      waitingForOpponent: 'Waiting for opponent...', // ADD THIS
      yourTurn: "It's your turn!", // ADD THIS
      waitingFor: 'Waiting for {name}...', // ADD THIS
      waiting: 'Waiting', // ADD THIS
      gameTie: "It's a Tie!", // ADD THIS
      youWin: 'You win! üéâ', // ADD THIS
      youLose: 'You lose. üòï', // ADD THIS
      cancelGame: 'Cancel Game', // ADD THIS
      backToLobby: 'Back to Lobby' // ADD THIS
    },
    es: {
      // ... (add Spanish translations)
      close: 'Cerrar',
      games: 'Juegos', // ADD THIS
      gameLobby: 'Lobby de Juegos', // ADD THIS
      createGame: 'Crear Nuevo Juego', // ADD THIS
      creating: 'Creando...', // ADD THIS
      openGames: 'Juegos Abiertos', // ADD THIS
      noOpenGames: 'No hay juegos. ¬°Crea uno!', // ADD THIS
      gameBy: 'Juego por {name}', // ADD THIS
      join: 'Unirse', // ADD THIS
      waitingForOpponent: 'Esperando oponente...', // ADD THIS
      yourTurn: '¬°Es tu turno!', // ADD THIS
      waitingFor: 'Esperando a {name}...', // ADD THIS
      waiting: 'Esperando', // ADD THIS
      gameTie: '¬°Es un empate!', // ADD THIS
      youWin: '¬°Ganaste! üéâ', // ADD THIS
      youLose: 'Perdiste. üòï', // ADD THIS
      cancelGame: 'Cancelar Juego', // ADD THIS
      backToLobby: 'Volver al Lobby' // ADD THIS
    },
    // ... add translations for your other languages (yo, it, fr, de)
    yo: {
      // ...
      games: '√Äw·ªçn Er√©',
      gameLobby: 'Gb·ªçÃÄng√†n Er√©',
      createGame: '·π¢·∫πda Er√© Tuntun',
      creating: 'N·π£·∫πda...',
      openGames: '√Äw·ªçn Er√© T√≠ √ì ·π¢√≠',
      noOpenGames: 'Ko si er√©. ·π¢·∫πda ·ªçÃÄkan!',
      gameBy: 'Er√© l√°ti ·ªçw·ªçÃÅ {name}',
      join: 'Darap·ªçÃÄ',
      waitingForOpponent: 'Nduro de al√°tak√≤...',
      yourTurn: '√åw·ªç lo kan!',
      waitingFor: 'Nduro de {name}...',
      waiting: 'Nduro',
      gameTie: '·∫∏ d·ªçÃÅgba!',
      youWin: 'O ·π£·∫πÃÅgun! üéâ',
      youLose: 'O p√†d√°n√π. üòï',
      cancelGame: 'Fagilee Er√©',
      backToLobby: 'Pad√† s√≠ Gb·ªçÃÄng√†n'
    },
    // ... etc. for it, fr, de
      loading: 'Loading...',
      logIn: 'Log In',
      password: 'Password',
      forgotPassword: 'Forgot password?',
      createAccount: 'Create Account',
      signUp: 'Sign Up',
      fullName: 'Full name',
      gender: 'Gender',
      male: 'Male',
      female: 'Female',
      other: 'Other',
      alreadyHaveAccount: 'Already have an account?',
      resetPassword: 'Reset Password',
      send: 'Send',
      cancel: 'Cancel',
      search: 'Search...',
      notifications: 'Notifications',
      home: 'Home',
      friends: 'Friends',
      messages: 'Messages',
      profile: 'Profile',
      settings: 'Settings',
      admin: 'Admin',
      whatsOnYourMind: "What's on your mind?",
      create: 'Create',
      createPost: 'Create Post',
      post: 'Post',
      posting: 'Posting...',
      noPosts: 'No posts yet',
      comment: 'Comment...',
      requests: 'Requests',
      noRequests: 'No requests',
      accept: 'Accept',
      decline: 'Decline',
      noFriends: 'No friends yet',
      edit: 'Edit',
      addFriend: 'Add Friend',
      friendsDot: 'Friends ‚úî',
      requestSent: 'Request Sent',
      editProfile: 'Edit Profile',
      posts: 'Posts',
      about: 'About',
      noPostsYet: 'No posts',
      aboutYou: 'About',
      noBio: 'No bio available.',
      noMessages: 'No messages',
      language: 'Language',
      darkMode: 'Dark Mode',
      light: 'Light',
      dark: 'Dark',
      logout: 'Logout',
      helpSupport: 'Help & Support',
      contactUs: 'Contact us:',
      manageUsers: 'Manage Users',
      managePosts: 'Manage Posts',
      verifyUsersMessage: 'Verify users and set follower counts.',
      followerCountPlaceholder: 'Follower count (e.g. 1m)',
      save: 'Save',
      verify: 'Verify',
      removeVerify: 'Remove ‚úî',
      managePostsMessage: 'Set display like/comment counts for posts. Leave blank to show real counts.',
      likesReal: 'Likes (real: {count})',
      commentsReal: 'Comments (real: {count})',
      saveCounts: 'Save Counts',
      searchFriends: 'Search friends...',
      noFriendsMessage: 'No friends to message',
      noFriendsFound: 'No friends found.',
      startConversation: 'Start a conversation',
      typeMessage: 'Type a message...',
      changeBg: 'Change Background',
      clearBg: 'Clear Background',
      relevantComments: 'Showing relevant comments',
      installBanner: 'Add Space to your Home Screen!',
      install: 'Install',
      dismiss: 'Dismiss',
      blockUser: 'Block {name}',
      unsend: 'Unsend',
      unsendMessage: 'Unsend this message?',
      unsendConfirm: 'This will permanently delete the message for everyone.',
      yourEmail: 'Your Email (for feedback)',
      yourMessage: 'Your Message',
      submit: 'Submit',
      messageSent: '‚úÖ Message sent!',
      messageFailed: '‚ùå Message failed to send.',
      blockedUsers: 'Blocked Users',
      noBlockedUsers: "You haven't blocked anyone.",
      unblock: 'Unblock',
      close: 'Close'
    },
    es: {
      loading: 'Cargando...',
      logIn: 'Iniciar sesi√≥n',
      password: 'Contrase√±a',
      forgotPassword: '¬øOlvidaste tu contrase√±a?',
      createAccount: 'Crear cuenta',
      signUp: 'Registrarse',
      fullName: 'Nombre completo',
      gender: 'G√©nero',
      male: 'Masculino',
      female: 'Femenino',
      other: 'Otro',
      alreadyHaveAccount: '¬øYa tienes una cuenta?',
      resetPassword: 'Restablecer contrase√±a',
      send: 'Enviar',
      cancel: 'Cancelar',
      search: 'Buscar...',
      notifications: 'Notificaciones',
      home: 'Inicio',
      friends: 'Amigos',
      messages: 'Mensajes',
      profile: 'Perfil',
      settings: 'Ajustes',
      admin: 'Admin',
      whatsOnYourMind: '¬øQu√© est√°s pensando?',
      create: 'Crear',
      createPost: 'Crear publicaci√≥n',
      post: 'Publicar',
      posting: 'Publicando...',
      noPosts: 'No hay publicaciones todav√≠a',
      comment: 'Comentar...',
      requests: 'Solicitudes',
      noRequests: 'No hay solicitudes',
      accept: 'Aceptar',
      decline: 'Rechazar',
      noFriends: 'No hay amigos todav√≠a',
      edit: 'Editar',
      addFriend: 'A√±adir amigo',
      friendsDot: 'Amigos ‚úî',
      requestSent: 'Solicitud enviada',
      editProfile: 'Editar perfil',
      posts: 'Publicaciones',
      about: 'Acerca de',
      noPostsYet: 'No hay publicaciones',
      aboutYou: 'Acerca de',
      noBio: 'No hay biograf√≠a disponible.',
      noMessages: 'No hay mensajes',
      language: 'Idioma',
      darkMode: 'Modo oscuro',
      light: 'Claro',
      dark: 'Oscuro',
      logout: 'Cerrar sesi√≥n',
      helpSupport: 'Ayuda y soporte',
      contactUs: 'Cont√°ctanos:',
      manageUsers: 'Gestionar usuarios',
      managePosts: 'Gestionar publicaciones',
      verifyUsersMessage: 'Verificar usuarios y establecer recuento de seguidores.',
      followerCountPlaceholder: 'Recuento de seguidores (ej. 1m)',
      save: 'Guardar',
      verify: 'Verificar',
      removeVerify: 'Quitar ‚úî',
      managePostsMessage: 'Establecer recuentos de "me gusta"/comentarios. Dejar en blanco para recuentos reales.',
      likesReal: 'Me gusta (real: {count})',
      commentsReal: 'Comentarios (real: {count})',
      saveCounts: 'Guardar recuentos',
      searchFriends: 'Buscar amigos...',
      noFriendsMessage: 'No hay amigos para enviar mensajes',
      noFriendsFound: 'No se encontraron amigos.',
      startConversation: 'Iniciar una conversaci√≥n',
      typeMessage: 'Escribe un mensaje...',
      changeBg: 'Cambiar fondo',
      clearBg: 'Quitar fondo',
      relevantComments: 'Mostrando comentarios relevantes',
      installBanner: '¬°A√±ade Space a tu pantalla de inicio!',
      install: 'Instalar',
      dismiss: 'Omitir',
      blockUser: 'Bloquear a {name}',
      unsend: 'Anular env√≠o',
      unsendMessage: '¬øAnular el env√≠o de este mensaje?',
      unsendConfirm: 'Esto eliminar√° permanentemente el mensaje para todos.',
      yourEmail: 'Tu correo (para respuesta)',
      yourMessage: 'Tu mensaje',
      submit: 'Entregar',
      messageSent: '‚úÖ ¬°Mensaje enviado!',
      messageFailed: '‚ùå Error al enviar el mensaje.',
      blockedUsers: 'Usuarios bloqueados',
      noBlockedUsers: 'No has bloqueado a nadie.',
      unblock: 'Desbloquear',
      close: 'Cerrar'
    },
    yo: {
      loading: 'N·π£i·π£·∫π...',
      logIn: 'W·ªçle',
      password: '·ªår·ªçigbaniw·ªçle',
      forgotPassword: '·π¢e o gbagbe ·ªçr·ªç igbaniw·ªçle?',
      createAccount: '·π¢·∫πda iroyin',
      signUp: 'Foruk·ªçsil·∫π',
      fullName: 'Oruk·ªç kikun',
      gender: 'Ako/Abo',
      male: 'Okunrin',
      female: 'Obinrin',
      other: 'Omiiran',
      alreadyHaveAccount: '·π¢e o ti ni iroyin t·∫πl·∫π?',
      resetPassword: 'Tunto ·ªçr·ªç igbaniw·ªçle',
      send: 'Firan·π£·∫π',
      cancel: 'Fagilee',
      search: 'Wa...',
      notifications: 'Aw·ªçn iwifunni',
      home: 'Ile',
      friends: 'Aw·ªçn ·ªçr·∫π',
      messages: 'Aw·ªçn ifiran·π£·∫π',
      profile: 'Profaili',
      settings: '√àt√≤',
      admin: 'Abojuto',
      whatsOnYourMind: 'Kini o wa ni ·ªçkan r·∫π?',
      create: '·π¢·∫πda',
      createPost: '·π¢·∫πda ifiweran·π£·∫π',
      post: 'Fiweran·π£·∫π',
      posting: 'Nfiweran·π£·∫π...',
      noPosts: 'Ko si ifiweran·π£·∫π kankan',
      comment: 'S·ªç as·ªçye...',
      requests: 'Aw·ªçn ibeere',
      noRequests: 'Ko si ibeere',
      accept: 'Gba',
      decline: 'K·ªç',
      noFriends: 'Ko si ·ªçr·∫π kankan',
      edit: '·π¢atunk·ªç',
      addFriend: 'Fi ·ªçr·∫π kun',
      friendsDot: '·ªår·∫π ‚úî',
      requestSent: 'Ibeere ti ran·π£·∫π',
      editProfile: '·π¢atunk·ªç profaili',
      posts: 'Aw·ªçn ifiweran·π£·∫π',
      about: 'Nipa',
      noPostsYet: 'Ko si ifiweran·π£·∫π',
      aboutYou: 'Nipa',
      noBio: 'Ko si alaye nipa r·∫π.',
      noMessages: 'Ko si ifiran·π£·∫π',
      language: 'Ede',
      darkMode: 'Ipo Dudu',
      light: 'Im·ªçl·∫π',
      dark: 'Dudu',
      logout: 'Jade',
      helpSupport: 'Iranl·ªçw·ªç ati Atil·∫πyin',
      contactUs: 'Pe wa:',
      manageUsers: '·π¢akoso aw·ªçn olumulo',
      managePosts: '·π¢akoso aw·ªçn ifiweran·π£·∫π',
      verifyUsersMessage: 'Daju aw·ªçn olumulo ati ·π£eto n·ªçmba aw·ªçn ·ªçm·ªçl·∫πyin.',
      followerCountPlaceholder: 'N·ªçmba aw·ªçn ·ªçm·ªçl·∫πyin (fun ap·∫π·∫πr·∫π, 1m)',
      save: 'Fipam·ªç',
      verify: 'Daju',
      removeVerify: 'Y·ªç ‚úî kuro',
      managePostsMessage: '·π¢eto aw·ªçn n·ªçmba if·∫π ati as·ªçye. Fi sil·∫π ni ofo fun n·ªçmba gidi.',
      likesReal: 'Aw·ªçn if·∫π (gidi: {count})',
      commentsReal: 'Aw·ªçn as·ªçye (gidi: {count})',
      saveCounts: 'Fipam·ªç Aw·ªçn n·ªçmba',
      searchFriends: 'Wa aw·ªçn ·ªçr·∫π...',
      noFriendsMessage: 'Ko si ·ªçr·∫π lati fi ifiran·π£·∫π ran·π£·∫π si',
      noFriendsFound: 'Ko ri ·ªçr·∫π kankan.',
      startConversation: 'B·∫πr·∫π ibara·∫πnis·ªçr·ªç',
      typeMessage: 'T·∫π ifiran·π£·∫π...',
      changeBg: 'Yi ab·∫πl·∫π pada',
      clearBg: 'Pa ab·∫πl·∫π r·∫π',
      relevantComments: 'Nfi aw·ªçn as·ªçye to wulo han',
      installBanner: 'Fi Space kun Iboju Ile r·∫π!',
      install: 'Fi sori ·∫πr·ªç',
      dismiss: 'K·ªç',
      blockUser: 'Dina {name}',
      unsend: 'Fagilee ifiran·π£·∫π',
      unsendMessage: '·π¢e o f·∫π fagilee ifiran·π£·∫π yii?',
      unsendConfirm: 'Eyi yoo pa ifiran·π£·∫π naa r·∫π patapata fun gbogbo eniyan.',
      yourEmail: 'Imeeli r·∫π (fun esi)',
      yourMessage: 'Ifiran·π£·∫π r·∫π',
      submit: 'Gbigbe',
      messageSent: '‚úÖ Ifiran·π£·∫π ti ran·π£·∫π!',
      messageFailed: '‚ùå Ifiran·π£·∫π ko l·ªç.',
      blockedUsers: '√Äw·ªçn T√≠ O D√≠n√†',
      noBlockedUsers: 'O k√≤ t√≠√¨ d√≠n√† ·∫πnik·∫πÃÅni.',
      unblock: '·π¢√≠ Din√†',
      close: 'T√¨ Pa'
    },
    it: {
      loading: 'Caricamento...',
      logIn: 'Accedi',
      password: 'Password',
      forgotPassword: 'Password dimenticata?',
      createAccount: 'Crea account',
      signUp: 'Iscriviti',
      fullName: 'Nome e cognome',
      gender: 'Genere',
      male: 'Maschio',
      female: 'Femmina',
      other: 'Altro',
      alreadyHaveAccount: 'Hai gi√† un account?',
      resetPassword: 'Reimposta password',
      send: 'Invia',
      cancel: 'Annulla',
      search: 'Cerca...',
      notifications: 'Notifiche',
      home: 'Home',
      friends: 'Amici',
      messages: 'Messaggi',
      profile: 'Profilo',
      settings: 'Impostazioni',
      admin: 'Admin',
      whatsOnYourMind: 'A cosa stai pensando?',
      create: 'Crea',
      createPost: 'Crea post',
      post: 'Pubblica',
      posting: 'Pubblicazione...',
      noPosts: 'Nessun post ancora',
      comment: 'Commenta...',
      requests: 'Richieste',
      noRequests: 'Nessuna richiesta',
      accept: 'Accetta',
      decline: 'Rifiuta',
      noFriends: 'Nessun amico ancora',
      edit: 'Modifica',
      addFriend: 'Aggiungi amico',
      friendsDot: 'Amici ‚úî',
      requestSent: 'Richiesta inviata',
      editProfile: 'Modifica profilo',
      posts: 'Post',
      about: 'Informazioni',
      noPostsYet: 'Nessun post',
      aboutYou: 'Informazioni',
      noBio: 'Nessuna biografia disponibile.',
      noMessages: 'Nessun messaggio',
      language: 'Lingua',
      darkMode: 'Modalit√† scura',
      light: 'Chiaro',
      dark: 'Scuro',
      logout: 'Esci',
      helpSupport: 'Aiuto e supporto',
      contactUs: 'Contattaci:',
      manageUsers: 'Gestisci utenti',
      managePosts: 'Gestisci post',
      verifyUsersMessage: 'Verifica utenti e imposta conteggio follower.',
      followerCountPlaceholder: 'Conteggio follower (es. 1m)',
      save: 'Salva',
      verify: 'Verifica',
      removeVerify: 'Rimuovi ‚úî',
      managePostsMessage: 'Imposta conteggi like/commenti. Lascia vuoto per i conteggi reali.',
      likesReal: 'Mi piace (reali: {count})',
      commentsReal: 'Commenti (reali: {count})',
      saveCounts: 'Salva conteggi',
      searchFriends: 'Cerca amici...',
      noFriendsMessage: 'Nessun amico con cui messaggiare',
      noFriendsFound: 'Nessun amico trovato.',
      startConversation: 'Inizia una conversazione',
      typeMessage: 'Scrivi un messaggio...',
      changeBg: 'Cambia sfondo',
      clearBg: 'Cancella sfondo',
      relevantComments: 'Mostrando commenti pertinenti',
      installBanner: 'Aggiungi Space alla tua Home!',
      install: 'Installa',
      dismiss: 'Ignora',
      blockUser: 'Blocca {name}',
      unsend: 'Annulla invio',
      unsendMessage: 'Annullare l"invio di questo messaggio?',
      unsendConfirm: 'Questo eliminer√† permanentemente il messaggio per tutti.',
      yourEmail: 'La tua email (per feedback)',
      yourMessage: 'Il tuo messaggio',
      submit: 'Invia',
      messageSent: '‚úÖ Messaggio inviato!',
      messageFailed: '‚ùå Invio messaggio non riuscito.',
      blockedUsers: 'Utenti bloccati',
      noBlockedUsers: 'Non hai bloccato nessuno.',
      unblock: 'Sblocca',
      close: 'Chiudi'
    },
    fr: {
      loading: 'Chargement...',
      logIn: 'Connexion',
      password: 'Mot de passe',
      forgotPassword: 'Mot de passe oubli√© ?',
      createAccount: 'Cr√©er un compte',
      signUp: "S'inscrire",
      fullName: 'Nom complet',
      gender: 'Genre',
      male: 'Homme',
      female: 'Femme',
      other: 'Autre',
      alreadyHaveAccount: 'Vous avez d√©j√† un compte ?',
      resetPassword: 'R√©initialiser le mot de passe',
      send: 'Envoyer',
      cancel: 'Annuler',
      search: 'Rechercher...',
      notifications: 'Notifications',
      home: 'Accueil',
      friends: 'Amis',
      messages: 'Messages',
      profile: 'Profil',
      settings: 'Param√®tres',
      admin: 'Admin',
      whatsOnYourMind: '√Ä quoi pensez-vous ?',
      create: 'Cr√©er',
      createPost: 'Cr√©er une publication',
      post: 'Publier',
      posting: 'Publication...',
      noPosts: 'Aucune publication pour le moment',
      comment: 'Commenter...',
      requests: 'Demandes',
      noRequests: 'Aucune demande',
      accept: 'Accepter',
      decline: 'Refuser',
      noFriends: "Pas encore d'amis",
      edit: 'Modifier',
      addFriend: 'Ajouter un ami',
      friendsDot: 'Amis ‚úî',
      requestSent: 'Demande envoy√©e',
      editProfile: 'Modifier le profil',
      posts: 'Publications',
      about: '√Ä propos',
      noPostsYet: 'Aucune publication',
      aboutYou: '√Ä propos',
      noBio: 'Aucune biographie disponible.',
      noMessages: 'Aucun message',
      language: 'Langue',
      darkMode: 'Mode sombre',
      light: 'Clair',
      dark: 'Sombre',
      logout: 'D√©connexion',
      helpSupport: 'Aide et support',
      contactUs: 'Contactez-nous :',
      manageUsers: 'G√©rer les utilisateurs',
      managePosts: 'G√©rer les publications',
      verifyUsersMessage: 'V√©rifier les utilisateurs et d√©finir le nombre d"abonn√©s.',
      followerCountPlaceholder: 'Nombre d"abonn√©s (ex. 1m)',
      save: 'Enregistrer',
      verify: 'V√©rifier',
      removeVerify: 'Retirer ‚úî',
      managePostsMessage: 'D√©finir les compteurs de likes/commentaires. Laisser vide pour les vrais compteurs.',
      likesReal: 'Likes (r√©els: {count})',
      commentsReal: 'Commentaires (r√©els: {count})',
      saveCounts: 'Enregistrer les comptes',
      searchFriends: 'Rechercher des amis...',
      noFriendsMessage: 'Aucun ami √† qui envoyer un message',
      noFriendsFound: 'Aucun ami trouv√©.',
      startConversation: 'D√©marrer une conversation',
      typeMessage: '√âcrire un message...',
      changeBg: 'Changer le fond',
      clearBg: 'Effacer le fond',
      relevantComments: 'Affichage des commentaires pertinents',
      installBanner: "Ajoutez Space √† votre √©cran d'accueil !",
      install: 'Installer',
      dismiss: 'Rejeter',
      blockUser: 'Bloquer {name}',
      unsend: 'Annuler l"envoi',
      unsendMessage: "Annuler l'envoi de ce message ?",
      unsendConfirm: 'Cela supprimera d√©finitivement le message pour tout le monde.',
      yourEmail: 'Votre e-mail (pour un retour)',
      yourMessage: 'Votre message',
      submit: 'Soumettre',
      messageSent: '‚úÖ Message envoy√© !',
      messageFailed: "‚ùå √âchec de l'envoi du message.",
      blockedUsers: 'Utilisateurs bloqu√©s',
      noBlockedUsers: 'Vous n"avez bloqu√© personne.',
      unblock: 'D√©bloquer',
      close: 'Fermer'
    },
    de: {
      loading: 'Wird geladen...',
      logIn: 'Anmelden',
      password: 'Passwort',
      forgotPassword: 'Passwort vergessen?',
      createAccount: 'Konto erstellen',
      signUp: 'Registrieren',
      fullName: 'Vollst√§ndiger Name',
      gender: 'Geschlecht',
      male: 'M√§nnlich',
      female: 'Weiblich',
      other: 'Andere',
      alreadyHaveAccount: 'Haben Sie bereits ein Konto?',
      resetPassword: 'Passwort zur√ºcksetzen',
      send: 'Senden',
      cancel: 'Abbrechen',
      search: 'Suchen...',
      notifications: 'Benachrichtigungen',
      home: 'Start',
      friends: 'Freunde',
      messages: 'Nachrichten',
      profile: 'Profil',
      settings: 'Einstellungen',
      admin: 'Admin',
      whatsOnYourMind: 'Was denkst du gerade?',
      create: 'Erstellen',
      createPost: 'Beitrag erstellen',
      post: 'Posten',
      posting: 'Wird gepostet...',
      noPosts: 'Noch keine Beitr√§ge',
      comment: 'Kommentieren...',
      requests: 'Anfragen',
      noRequests: 'Keine Anfragen',
      accept: 'Annehmen',
      decline: 'Ablehnen',
      noFriends: 'Noch keine Freunde',
      edit: 'Bearbeiten',
      addFriend: 'Freund hinzuf√ºgen',
      friendsDot: 'Freunde ‚úî',
      requestSent: 'Anfrage gesendet',
      editProfile: 'Profil bearbeiten',
      posts: 'Beitr√§ge',
      about: '√úber',
      noPostsYet: 'Keine Beitr√§ge',
      aboutYou: '√úber',
      noBio: 'Keine Bio verf√ºgbar.',
      noMessages: 'Keine Nachrichten',
      language: 'Sprache',
      darkMode: 'Dunkelmodus',
      light: 'Hell',
      dark: 'Dunkel',
      logout: 'Abmelden',
      helpSupport: 'Hilfe & Support',
      contactUs: 'Kontaktiere uns:',
      manageUsers: 'Benutzer verwalten',
      managePosts: 'Beitr√§ge verwalten',
      verifyUsersMessage: 'Benutzer verifizieren und Follower-Anzahl festlegen.',
      followerCountPlaceholder: 'Follower-Anzahl (z.B. 1m)',
      save: 'Speichern',
      verify: 'Verifizieren',
      removeVerify: '‚úî entfernen',
      managePostsMessage: 'Like-/Kommentar-Anzeige festlegen. Leer lassen for echte Zahlen.',
      likesReal: 'Likes (echt: {count})',
      commentsReal: 'Kommentare (echt: {count})',
      saveCounts: 'Zahlen speichern',
      searchFriends: 'Freunde suchen...',
      noFriendsMessage: 'Keine Freunde zum Chatten',
      noFriendsFound: 'Keine Freunde gefunden.',
      startConversation: 'Gespr√§ch beginnen',
      typeMessage: 'Nachricht eingeben...',
      changeBg: 'Hintergrund √§ndern',
      clearBg: 'Hintergrund l√∂schen',
      relevantComments: 'Relevante Kommentare werden angezeigt',
      installBanner: 'Space zum Startbildschirm hinzuf√ºgen!',
      install: 'Installieren',
      dismiss: 'Schlie√üen',
      blockUser: '{name} blockieren',
      unsend: 'Senden r√ºckg√§ngig machen',
      unsendMessage: 'Senden dieser Nachricht r√ºckg√§ngig machen?',
      unsendConfirm: 'Dadurch wird die Nachricht dauerhaft f√ºr alle gel√∂scht.',
      yourEmail: 'Ihre E-Mail (f√ºr Feedback)',
      yourMessage: 'Ihre Nachricht',
      submit: 'Senden',
      messageSent: '‚úÖ Nachricht gesendet!',
      messageFailed: '‚ùå Senden der Nachricht fehlgeschlagen.',
      blockedUsers: 'Blockierte Benutzer',
      noBlockedUsers: 'Du hast niemanden blockiert.',
      unblock: 'Entblocken',
      close: 'Schlie√üen'
    }
  };
  // --- END I18N ---

  const CONFIG = window.SPACE_CONFIG || {};
  const app = initializeApp(CONFIG.firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const CLOUDINARY_CLOUD = CONFIG.cloudinary?.cloudName || "";
  const CLOUDINARY_UPLOAD_PRESET = CONFIG.cloudinary?.uploadPreset || "";
  const ADMIN_EMAIL = (CONFIG.ADMIN_EMAIL || "").toLowerCase();

  const getChatId = (uid1, uid2) => [uid1, uid2].sort().join('_');

  async function uploadToCloudinary(file) {
    if (!CLOUDINARY_CLOUD || !CLOUDINARY_UPLOAD_PRESET) throw new Error('Cloudinary not configured');
    const typeSegment = file.type.startsWith('video') ? 'video' : 'image';
    const url = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD}/${typeSegment}/upload`;
    const form = new FormData();
    form.append('file', file);
    form.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
    const res = await fetch(url, { method: 'POST', body: form });
    return res.json();
  }

  async function createUserProfile(uid, profile) {
    await setDoc(doc(db, 'users', uid), {
      ...profile,
      bio: '',
      status: '',
      followerCount: '',
      createdAt: serverTimestamp(),
      email: profile.email.toLowerCase()
    });
  }
  async function getUserProfile(uid) {
    if (!uid) return null;
    const d = await getDoc(doc(db, 'users', uid));
    return d.exists() ? { id: d.id, ...d.data() } : null;
  }
  async function searchUsers(term) {
    if (!term || term.length < 2) return [];
    const q = query(collection(db, 'users'), where('displayNameLower', '>=', term.toLowerCase()), orderBy('displayNameLower'), limit(10));
    const snap = await getDocs(q);
    return snap.docs.map(d => ({ id: d.id, ...d.data() }));
  }

  async function createPost(post) {
    return addDoc(collection(db, 'posts'), {
      ...post,
      likes: [],
      comments: [],
      createdAt: serverTimestamp(),
      displayLikeCount: '',
      displayCommentCount: ''
    });
  }
  function subscribeFeed(cb) { const q = query(collection(db, 'posts'), orderBy('createdAt','desc')); return onSnapshot(q, snap => cb(snap.docs.map(d=>({ id: d.id, ...d.data() })))); }
  async function updatePost(postId, data) { return updateDoc(doc(db,'posts',postId), data); }
  async function deletePost(postId) { return deleteDoc(doc(db,'posts',postId)); }
  async function toggleLike(postId, uid) {
    const postRef = doc(db, 'posts', postId);
    const postSnap = await getDoc(postRef);
    if (!postSnap.exists()) return;
    const likes = postSnap.data().likes || [];
    if (likes.includes(uid)) {
      await updateDoc(postRef, { likes: arrayRemove(uid) });
    } else {
      await updateDoc(postRef, { likes: arrayUnion(uid) });
    }
  }
  async function addComment(postId, uid, text) {
    const postRef = doc(db, 'posts', postId);
    const newComment = {
      uid,
      text,
      createdAt: new Date().toISOString()
    };
    await updateDoc(postRef, { comments: arrayUnion(newComment) });
  }

  async function createStory(uid, mediaUrl, mediaType) {
    const expiresAt = new Date(Date.now() + 24 * 60 * 60 * 1000);
    return addDoc(collection(db, 'stories'), { uid, mediaUrl, mediaType, createdAt: serverTimestamp(), expiresAt: expiresAt.toISOString() });
  }
  function subscribeStories(cb) {
    const q = query(collection(db, 'stories'), orderBy('createdAt','desc'));
    return onSnapshot(q, snap => {
      const now = new Date();
      const active = snap.docs.map(d=>({ id: d.id, ...d.data() })).filter(s => {
        if (!s.expiresAt) return true;
        return new Date(s.expiresAt) > now;
      });
      cb(active);
    });
  }

  async function sendFriendRequest(from, to) {
    const id = `${from}_${to}`;
    const reverseId = `${to}_${from}`;
    const reverseSnap = await getDoc(doc(db, 'friends', reverseId));
    if (reverseSnap.exists()) {
      if (reverseSnap.data().status === 'pending') {
        await acceptFriendRequest(reverseId);
        return;
      }
    }
    await setDoc(doc(db, 'friends', id), { requester: from, target: to, status: 'pending', createdAt: serverTimestamp() });
  }
  async function acceptFriendRequest(requestId) {
    await updateDoc(doc(db, 'friends', requestId), { status: 'accepted' });
  }
  async function declineFriendRequest(requestId) {
    await deleteDoc(doc(db, 'friends', requestId));
  }
  async function getFriendRequests(uid) {
    const q = query(collection(db, 'friends'), where('target', '==', uid), where('status', '==', 'pending'));
    const snap = await getDocs(q);
    return snap.docs.map(d => ({ id: d.id, ...d.data() }));
  }
  async function getFriends(uid) {
    const q1 = query(collection(db, 'friends'), where('status', '==', 'accepted'), where('requester', '==', uid));
    const q2 = query(collection(db, 'friends'), where('status', '==', 'accepted'), where('target', '==', uid));
    const [snap1, snap2] = await Promise.all([getDocs(q1), getDocs(q2)]);
    const friendsData = [
      ...snap1.docs.map(d => d.data()),
      ...snap2.docs.map(d => d.data())
    ];
    const friendIds = friendsData.map(f => f.requester === uid ? f.target : f.requester);

    const blocksQuery = query(collection(db, 'blocks'), where('by', '==', uid));
    const blocksSnap = await getDocs(blocksQuery);
    const blockedIds = blocksSnap.docs.map(d => d.data().for);

    return friendIds.filter(id => !blockedIds.includes(id));
  }
  async function getFriendStatus(uid1, uid2) {
    if (!uid1 || !uid2) return null;
    const id1 = `${uid1}_${uid2}`;
    const id2 = `${uid2}_${uid1}`;
    const [snap1, snap2] = await Promise.all([
      getDoc(doc(db, 'friends', id1)),
      getDoc(doc(db, 'friends', id2))
    ]);
    if (snap1.exists()) return snap1.data().status;
    if (snap2.exists()) return snap2.data().status;
    return null;
  }

  // --- CHAT FUNCTIONS ---
  async function sendMessage(chatId, from, to, { text, media }) {
    if (!text && !media) return;

    try {
      const q1 = query(collection(db, 'blocks'), where('by', '==', from), where('for', '==', to));
      const snap1 = await getDocs(q1);
      const q2 = query(collection(db, 'blocks'), where('by', '==', to), where('for', '==', from));
      const snap2 = await getDocs(q2);

      if (!snap1.empty || !snap2.empty) {
        alert("Cannot send message. User is blocked or has blocked you.");
        return;
      }
    } catch (err) { console.error('Block check failed:', err); }

    const lastMessage = text ? text : (media.type === 'video' ? 'üé• Video' : 'üì∑ Photo');
    const targetUnreadKey = `unreadCount_${to}`;
    const fromUnreadKey = `unreadCount_${from}`;

    const chatRef = doc(db, 'chats', chatId);
    const chatSnap = await getDoc(chatRef);

    if (!chatSnap.exists()) {
      await setDoc(chatRef, {
        participants: chatId.split('_'),
        lastMessage: lastMessage,
        updatedAt: serverTimestamp(),
        [targetUnreadKey]: 1,
        [fromUnreadKey]: 0
      });
    } else {
      await updateDoc(chatRef, {
        lastMessage: lastMessage,
        updatedAt: serverTimestamp(),
        [targetUnreadKey]: increment(1)
      });
    }

    await addDoc(collection(db, `chats/${chatId}/messages`), {
      from,
      text: text || null,
      media: media || null,
      read: false,
      createdAt: serverTimestamp()
    });
  }

  async function unsendMessage(chatId, messageId) {
    await deleteDoc(doc(db, 'chats', chatId, 'messages', messageId));
  }

  async function blockUser(currentUid, targetUid) {
    const blockId = `${currentUid}_${targetUid}`;
    await setDoc(doc(db, 'blocks', blockId), {
      by: currentUid,
      for: targetUid,
      createdAt: serverTimestamp()
    });

    const friendId1 = `${currentUid}_${targetUid}`;
    const friendId2 = `${targetUid}_${currentUid}`;
    await deleteDoc(doc(db, 'friends', friendId1));
    await deleteDoc(doc(db, 'friends', friendId2));
  }

  async function unblockUser(currentUid, targetUid) {
    const blockId = `${currentUid}_${targetUid}`;
    await deleteDoc(doc(db, 'blocks', blockId));
  }

  async function clearUnreadCount(chatId, uid) {
    try {
      const chatRef = doc(db, 'chats', chatId);
      const chatSnap = await getDoc(chatRef);
      if (chatSnap.exists()) {
        const key = `unreadCount_${uid}`;
        await updateDoc(chatRef, { [key]: 0 });
      }
    } catch (err) { console.error('Clear unread failed:', err); }
  }

  function subscribeMessages(chatId, cb) {
    const q = query(collection(db, `chats/${chatId}/messages`), orderBy('createdAt','desc'));
    return onSnapshot(q, snap => cb(snap.docs.map(d=>({ id: d.id, ...d.data() }))));
  }
  function subscribeChatData(chatId, cb) {
    return onSnapshot(doc(db, 'chats', chatId), (doc) => {
      if (doc.exists()) { cb(doc.data()); }
      else { cb(null); }
    });
  }
  // --- END CHAT FUNCTIONS ---

  function fmtDate(ts) {
    if (!ts) return '';
    try {
      const date = ts.seconds ? new Date(ts.seconds*1000) : new Date(ts);
      const now = new Date();
      const diff = Math.floor((now - date) / 1000);
      if (diff < 60) return 'Just now';
      if (diff < 3600) return `${Math.floor(diff/60)}m`;
      if (diff < 86400) return `${Math.floor(diff/3600)}h`;
      return date.toLocaleDateString();
    } catch { return ''; }
  }

  function InstallBanner({ t, onInstall, onDismiss }) {
    return React.createElement('div', { className: 'install-banner' },
      React.createElement('div', { className: 'install-banner-text' }, t('installBanner')),
      React.createElement('div', { className: 'install-banner-buttons' },
        React.createElement('button', { className: 'btn-ghost', onClick: onDismiss }, t('dismiss')),
        React.createElement('button', { className: 'btn', onClick: onInstall }, t('install'))
      )
    );
  }

  function UnsendModal({ t, onCancel, onConfirm }) {
    return React.createElement('div', { className: 'modal', onClick: onCancel },
      React.createElement('div', { className: 'modal-content', onClick: e => e.stopPropagation() },
        React.createElement('h3', { style: { marginBottom:12 }}, t('unsendMessage')),
        React.createElement('p', { className: 'small', style: { marginBottom:20 }}, t('unsendConfirm')),
        React.createElement('div', { className: 'row', style: { gap:12 }},
          React.createElement('button', { className: 'btn-ghost', type: 'button', onClick: onCancel, style: { flex:1 }}, t('cancel')),
          React.createElement('button', { className: 'btn', type: 'button', onClick: onConfirm, style: { flex:1, background: '#fa3e3e' }}, t('unsend'))
        )
      )
    );
  }

  function App() {
    const [user, setUser] = useState(null);
    const [page, setPage] = useState('loading');
    const [feed, setFeed] = useState([]);
    const [stories, setStories] = useState([]);
    const [theme, setTheme] = useState(localStorage.getItem('theme') || 'light');
    const [lang, setLang] = useState(localStorage.getItem('lang') || 'en');
    const [searchTerm, setSearchTerm] = useState('');
    const [searchResults, setSearchResults] = useState([]);
    const [selectedProfile, setSelectedProfile] = useState(null);
    const [userProfile, setUserProfile] = useState(null);
    const [showComposer, setShowComposer] = useState(false);
    const [showForgot, setShowForgot] = useState(false);
    const [isAdmin, setIsAdmin] = useState(false);
    const [totalUnread, setTotalUnread] = useState(0);
    const [chatUnreadMap, setChatUnreadMap] = useState({});

    const [installPromptEvent, setInstallPromptEvent] = useState(null);
    const [showInstallBanner, setShowInstallBanner] = useState(false);
    const [showBlockedList, setShowBlockedList] = useState(false); // State for modal
    const [selectedGameId, setSelectedGameId] = useState(null);
    const t = (key, params = {}) => {
      let text = translations[lang]?.[key] || translations['en'][key] || key;
      Object.keys(params).forEach(p => {
        text = text.replace(`{${p}}`, params[p]);
      });
      return text;
    };

    const navTo = (p) => {
      if (p === 'profile') setSelectedProfile(null);
      setPage(p);
    };

    const navToProfile = (uid) => {
      setSelectedProfile(uid);
      setPage('profile');
    };

    const handleSetLang = (newLang) => {
      setLang(newLang);
      localStorage.setItem('lang', newLang);
    };

    useEffect(() => {
      const handler = (e) => {
        e.preventDefault();
        setInstallPromptEvent(e);
        if (!window.matchMedia('(display-mode: standalone)').matches) {
          setShowInstallBanner(true);
        }
      };
      window.addEventListener('beforeinstallprompt', handler);
      return () => window.removeEventListener('beforeinstallprompt', handler);
    }, []);

    const handleInstallClick = async () => {
      if (!installPromptEvent) return;
      installPromptEvent.prompt();
      const { outcome } = await installPromptEvent.userChoice;
      if (outcome === 'accepted') {
        console.log('User accepted the install prompt');
      }
      setShowInstallBanner(false);
      setInstallPromptEvent(null);
    };

    const handleDismissClick = () => {
      setShowInstallBanner(false);
    };

    useEffect(() => {
      if (!user) return;
      const q = query(collection(db, 'chats'), where('participants', 'array-contains', user.uid));
      const unsub = onSnapshot(q, (snap) => {
        let total = 0;
        const unreadMap = {};
        snap.forEach(doc => {
          const data = doc.data();
          const unreadKey = `unreadCount_${user.uid}`;
          const count = data[unreadKey] || 0;
          if (count > 0) {
            total += count;
            unreadMap[doc.id] = count;
          }
        });
        setTotalUnread(total);
        setChatUnreadMap(unreadMap);
      });
      return () => unsub();
    }, [user]);

    useEffect(()=> {
      const splash = document.getElementById('splash');
      onAuthStateChanged(auth, async (u) => {
        setUser(u);
        if (u) {
          const prof = await getUserProfile(u.uid);
          setUserProfile(prof);
          setIsAdmin(prof?.email === ADMIN_EMAIL);
          if (!prof) setPage('register');
          else setPage('home');
        } else {
          setPage('login');
          setIsAdmin(false);
        }
      });
      const unsubFeed = subscribeFeed(setFeed);
      const unsubStories = subscribeStories(setStories);
      setTimeout(()=> {
        if (splash) splash.style.display = 'none';
        document.getElementById('root').style.visibility = 'visible';
        if (window.SPACE_APP_OK) window.SPACE_APP_OK();
      }, 800);
      return ()=> { unsubFeed(); unsubStories(); };
    }, []);

    useEffect(()=> {
      document.documentElement.classList.toggle('dark', theme === 'dark');
      localStorage.setItem('theme', theme);
    }, [theme]);

    useEffect(()=> {
      const timeout = setTimeout(async ()=> {
        if (searchTerm.length >= 2) {
          const r = await searchUsers(searchTerm);
          setSearchResults(r);
        } else setSearchResults([]);
      }, 300);
      return ()=> clearTimeout(timeout);
    }, [searchTerm]);

    if (!user && (page === 'login' || page === 'register')) {
      return React.createElement('div', { className: 'container' },
        page === 'login' && React.createElement(LoginPage, { t, onSuccess: () => setPage('home'), onSwitch: () => setPage('register'), onForgot: () => setShowForgot(true) }),
        page === 'register' && React.createElement(RegisterPage, { t, onSuccess: () => setPage('home'), onSwitch: () => setPage('login') }),
        showForgot && React.createElement(ForgotModal, { t, onClose: () => setShowForgot(false) })
      );
    }

    // --- FIX 1: The 'if' block MUST be here, before the main return ---
    if (selectedGameId) {
      return React.createElement(TicTacToeGame, {
        t,
        user,
        gameId: selectedGameId,
        onLeaveGame: () => setSelectedGameId(null)
      });
    }

    return React.createElement('div', null,
      // The 'if' block has been removed from here
      showInstallBanner && React.createElement(InstallBanner, {
        t,
        onInstall: handleInstallClick,
        onDismiss: handleDismissClick
      }),
      React.createElement(TopBar, { t, user, userProfile, searchTerm, setSearchTerm, searchResults, page: page, onNav: navTo, onOpenProfile: navToProfile, unreadCount: totalUnread }),
      React.createElement('div', { className: 'container' },
        page === 'loading' && React.createElement('div', { className: 'card' }, t('loading')),
        page === 'home' && React.createElement(HomePage, { t, user, userProfile, feed, stories, showComposer, setShowComposer, onNavToProfile: navToProfile }),
        page === 'friends' && React.createElement(FriendsPage, { t, user, onNavToProfile: navToProfile }),
        page === 'profile' && React.createElement(ProfilePage, { t, uid: selectedProfile, currentUser: user, userProfile: userProfile, onNavToProfile: navToProfile }),
        page === 'messages' && React.createElement(MessagesPage, { t, currentUser: user, onNavToProfile: navToProfile, unreadMap: chatUnreadMap }),
        page === 'settings' && React.createElement(SettingsPage, {
          t, lang, setLang: handleSetLang, theme, setTheme, currentUser: user,
          onShowBlocked: () => setShowBlockedList(true) // Pass function
        }), // <-- FIX 2: Added missing comma
        
        page === 'games' && React.createElement(GameLobby, { t, user, userProfile, onJoinGame: setSelectedGameId }), // <-- FIX 3: Added missing comma

        // --- FIX 4: Removed the duplicate admin page line ---
        page === 'admin' && isAdmin && React.createElement(AdminPage, { t, currentUser: user })
      ),
      user && React.createElement(BottomNav, { t, page, setPage: navTo, userProfile, isAdmin, unreadCount: totalUnread }),

      showBlockedList && React.createElement(BlockedListModal, {
          t,
          currentUser: user,
          onClose: () => setShowBlockedList(false)
      }),

      showForgot && React.createElement(ForgotModal, { t, onClose: () => setShowForgot(false) }),
      showComposer && React.createElement(ComposerModal, { t, user, onClose: () => setShowComposer(false) })
    );
  } // --- END OF App() FUNCTION ---

  function TopBar({ t, user, userProfile, searchTerm, setSearchTerm, searchResults, page, onNav, onOpenProfile, unreadCount }) {
    return React.createElement('div', { className: 'topbar' },
      page !== 'home' && React.createElement('div', {
        className: 'icon-btn',
        onClick: () => onNav('home'),
        style: { background: 'transparent' }
      }, '‚¨ÖÔ∏è'),
      React.createElement('div', { className: 'topbar-logo', onClick: () => onNav('home') }, 'S'),
      user && React.createElement('div', { className: 'search-box' },
        React.createElement('input', { className: 'search-input', placeholder: t('search'), value: searchTerm, onInput: e => setSearchTerm(e.target.value) }),
        searchResults.length > 0 && React.createElement('div', { className: 'search-results' },
          searchResults.map(s => React.createElement('div', { key: s.id, className: 'search-item', onClick: () => { onOpenProfile(s.id); setSearchTerm(''); }},
            React.createElement('div', { className: 'row' },
              s.avatarUrl && React.createElement('img', { src: s.avatarUrl, className: 'avatar' }),
              React.createElement('div', null,
                React.createElement('div', { style: { fontWeight:600 } }, s.displayName),
                s.verified && React.createElement('span', {
                  title: 'Verified',
                  style: { marginLeft: 6, verticalAlign: 'middle' },
                  dangerouslySetInnerHTML: {
                    __html: '<svg viewBox="0 0 24 24" style="width:16px;height:16px;fill:#1D9BF0" xmlns="http://www.w3.org/2000/svg"><path d="M22.5 12.5c0-.9-.3-1.7-.8-2.4.3-.8.4-1.6.2-2.4-.2-.8-.7-1.5-1.3-2-.6-.5-1.4-.8-2.2-.9-.3-.7-.8-1.4-1.5-1.9-.7-.5-1.5-.8-2.4-.8s-1.7.3-2.4.8c-.7-.5-1.5-.8-2.4-.8s-1.7.3-2.4.8c-.7.5-1.2 1.2-1.5 1.9-.8.1-1.6.4-2.2.9-.6.5-1.1 1.2-1.3 2-.2.8-.1 1.6.2 2.4-.5.7-.8 1.5-.8 2.4s.3 1.7.8 2.4c-.3.8-.4 1.6-.2 2.4.2.8.7 1.5 1.3 2 .6.5 1.4.8 2.2.9.3.7.8 1.4 1.5 1.9.7.5 1.5.8 2.4.8s-1.7-.3 2.4-.8c.7.5 1.5.8 2.4.8s-1.7-.3 2.4-.8c.7-.5 1.2-1.2 1.5-1.9.8-.1 1.6-.4-2.2-.9.6-.5 1.1 1.2-1.3 2 .2-.8.1-1.6-.2-2.4.5-.7.8-1.5.8-2.4z"/><path fill="#fff" d="M10.8 14.9l-2.8-2.8 1.2-1.2 1.6 1.6 3.7-4 1.2 1.1z"/></svg>'
                  }
                })
              )
            )
          ))
        )
      ),
      user && React.createElement('div', { className: 'topbar-icons' },
        React.createElement('div', { className: 'icon-btn', onClick: () => onNav('messages'), title: t('notifications') },
          'üîî',
          unreadCount > 0 && React.createElement('div', { className: 'notif-badge' }, unreadCount)
        ),
        userProfile?.avatarUrl && React.createElement('img', { src: userProfile.avatarUrl, className: 'avatar', onClick: () => onNav('profile'), style: { cursor:'pointer' }})
      )
    );
  }

  ¬† function BottomNav({ t, page, setPage, userProfile, isAdmin, unreadCount }) {
    const navItems = ['home', 'friends', 'messages', 'games', 'profile', 'settings'];
    const icons = { 
        home: 'üè†', 
        friends: 'üë•', 
        messages: 'üí¨', 
        games: 'üéÆ',
        profile: 'üë§', 
        settings: '‚öôÔ∏è', 
        admin: 'üõ°Ô∏è' 
    };

    if (isAdmin) navItems.push('admin');

    return React.createElement('div', { className: 'bottomnav' },
      navItems.map(p =>
        React.createElement('div', { key: p, className: `nav-item ${page === p ? 'active' : ''}`, onClick: () => setPage(p) },
          React.createElement('div', { className: 'nav-icon' }, icons[p]),
          React.createElement('div', { className: 'nav-label' }, t(p)),
          p === 'messages' && unreadCount > 0 && React.createElement('div', { className: 'notif-badge' }, unreadCount)
        )
      )
    );
  }



  function LoginPage({ t, onSuccess, onSwitch, onForgot }) {
    const [email, setEmail] = useState('');
    const [password, setPassword] = useState('');
    const [msg, setMsg] = useState('');
    async function submit(e) {
      e?.preventDefault();
      setMsg('');
      try {
        await signInWithEmailAndPassword(auth, email, password);
        onSuccess();
      } catch (err) {
        setMsg(err.message);
      }
    }
    return React.createElement('div', { className: 'card card-lg', style: { maxWidth:400, margin:'60px auto' }},
      React.createElement('h1', { style: { textAlign:'center', background:'var(--gradient)', WebkitBackgroundClip:'text', WebkitTextFillColor:'transparent', marginBottom:24 }}, 'Space'),
      React.createElement('form', { onSubmit: submit, className: 'col' },
        React.createElement('input', { placeholder: 'Email', type: 'email', value: email, onInput: e => setEmail(e.target.value), required: true }),
        React.createElement('input', { placeholder: t('password'), type: 'password', value: password, onInput: e => setPassword(e.target.value), required: true }),
        React.createElement('button', { className: 'btn', type: 'submit', style: { width:'100%' }}, t('logIn')),
        React.createElement('a', { href: '#', onClick: e => { e.preventDefault(); onForgot(); }, style: { textAlign:'center', fontSize:14, color:'var(--primary)' }}, t('forgotPassword')),
        msg && React.createElement('div', { style: { color:'#fa3e3e', fontSize:14, textAlign:'center' }}, msg)
      ),
      React.createElement('div', { style: { textAlign:'center', marginTop:20, paddingTop:20, borderTop:'1px solid var(--hover)' }},
        React.createElement('button', { className: 'btn-secondary', onClick: onSwitch, style: { padding:'10px 24px', borderRadius:6 }}, t('createAccount'))
      )
    );
  }

  function RegisterPage({ t, onSuccess, onSwitch }) {
    const [form, setForm] = useState({ name:'', dob:'', gender:'', email:'', password:'' });
    const [error, setError] = useState('');
    async function submit(e) {
      e?.preventDefault();
      setError('');
      try {
        const cred = await createUserWithEmailAndPassword(auth, form.email, form.password);
        const isAdmin = form.email.toLowerCase() === ADMIN_EMAIL;
        await createUserProfile(cred.user.uid, {
          displayName: form.name,
          displayNameLower: form.name.toLowerCase(),
          dob: form.dob,
          gender: form.gender,
          email: form.email,
          avatarUrl: null,
          coverUrl: null,
          verified: isAdmin
        });
        if (ADMIN_EMAIL && !isAdmin) {
          const q = query(collection(db,'users'), where('email','==',ADMIN_EMAIL));
          const snap = await getDocs(q);
          if (!snap.empty) await sendFriendRequest(cred.user.uid, snap.docs[0].id);
        }
        try { await sendEmailVerification(cred.user); } catch(e){}
        alert('‚úÖ Account created!');
        onSuccess();
      } catch (err) {
        setError(err.message);
      }
    }
    return React.createElement('div', { className: 'card card-lg', style: { maxWidth:400, margin:'40px auto' }},
      React.createElement('h2', { style: { textAlign:'center', marginBottom:24 }}, t('signUp')),
      React.createElement('form', { onSubmit: submit, className: 'col' },
        React.createElement('input', { placeholder: t('fullName'), value: form.name, onInput: e => setForm({...form, name: e.target.value}), required: true }),
        React.createElement('input', { type: 'date', value: form.dob, onInput: e => setForm({...form, dob: e.target.value}), required: true }),
        React.createElement('select', { value: form.gender, onChange: e => setForm({...form, gender: e.target.value}), required: true },
          React.createElement('option', { value: '' }, t('gender')),
          React.createElement('option', { value: 'male' }, t('male')),
          React.createElement('option', { value: 'female' }, t('female')),
          React.createElement('option', { value: 'other' }, t('other'))
        ),
        React.createElement('input', { placeholder: 'Email', type: 'email', value: form.email, onInput: e => setForm({...form, email: e.target.value}), required: true }),
        React.createElement('input', { placeholder: t('password'), type: 'password', value: form.password, onInput: e => setForm({...form, password: e.target.value}), required: true }),
        React.createElement('button', { className: 'btn', type: 'submit', style: { width:'100%' }}, t('signUp')),
        error && React.createElement('div', { style: { color:'#fa3e3e', fontSize:14, textAlign:'center' }}, error)
      ),
      React.createElement('div', { style: { textAlign:'center', marginTop:20 }},
        React.createElement('a', { href: '#', onClick: e => { e.preventDefault(); onSwitch(); }, style: { color:'var(--primary)' }}, t('alreadyHaveAccount'))
      )
    );
  }

  function ForgotModal({ t, onClose }) {
    const [email, setEmail] = useState('');
    const [msg, setMsg] = useState('');
    async function submit(e) {
      e?.preventDefault();
      try {
        await sendPasswordResetEmail(auth, email);
        setMsg('‚úÖ Reset link sent!');
        setTimeout(onClose, 2000);
      } catch (err) {
        setMsg('‚ùå ' + err.message);
      }
    }
    return React.createElement('div', { className: 'modal', onClick: onClose },
      React.createElement('div', { className: 'modal-content', onClick: e => e.stopPropagation() },
        React.createElement('h3', { style: { marginBottom:20 }}, t('resetPassword')),
        React.createElement('form', { onSubmit: submit, className: 'col' },
          React.createElement('input', { placeholder: 'Enter email', type: 'email', value: email, onInput: e => setEmail(e.target.value), required: true }),
          React.createElement('div', { className: 'row', style: { gap:12 }},
            React.createElement('button', { className: 'btn', type: 'submit', style: { flex:1 }}, t('send')),
            React.createElement('button', { className: 'btn-ghost', type: 'button', onClick: onClose, style: { flex:1 }}, t('cancel'))
          ),
          msg && React.createElement('div', { style: { textAlign:'center', marginTop:12 }}, msg)
        )
      )
    );
  }

  function HomePage({ t, user, userProfile, feed, stories, showComposer, setShowComposer, onNavToProfile }) {
    return React.createElement('div', null,
      React.createElement('div', { className: 'card' },
        React.createElement('div', { className: 'row', style: { alignItems:'flex-start', gap:16 }},
          userProfile?.avatarUrl ?
            React.createElement('img', { src: userProfile.avatarUrl, className: 'avatar-lg' }) :
            React.createElement('div', { className: 'avatar-lg', style: { background:'var(--gradient)', flexShrink:0 }}),
          React.createElement('button', { className: 'composer-trigger', onClick: () => setShowComposer(true), style: { flex:1 }}, t('whatsOnYourMind'))
        )
      ),
      React.createElement('div', { className: 'card', style: { padding:'16px 12px' }},
        React.createElement('div', { className: 'row', style: { overflowX:'auto', gap:12, paddingBottom:8 }},
          React.createElement(StoryComposer, { t, user }),
          stories.slice(0,5).map(s => React.createElement(StoryCard, { key: s.id, story: s }))
        )
      ),
      showComposer && React.createElement(ComposerModal, { t, user, onClose: () => setShowComposer(false) }),
      feed.length === 0 && React.createElement('div', { className: 'empty-state' },
        React.createElement('div', { className: 'empty-icon' }, 'üìù'),
        React.createElement('div', null, t('noPosts'))
      ),
      feed.map(p => React.createElement(PostCard, { t, key: p.id, post: p, currentUser: user, onNavToProfile: onNavToProfile }))
    );
  }

  function StoryComposer({ t, user }) {
    const fileInput = useRef(null);
    const [loading, setLoading] = useState(false);
    async function handleFile(e) {
      const file = e.target.files?.[0];
      if (!file) return;
      setLoading(true);
      try {
        const res = await uploadToCloudinary(file);
        await createStory(user.uid, res.secure_url, res.resource_type || 'image');
      } catch { alert('‚ùå Upload failed'); } finally { setLoading(false); }
    }
    return React.createElement('div', { className: 'story-circle', onClick: () => fileInput.current?.click(), style: { background:'var(--hover)', display:'flex', alignItems:'center', justifyContent:'center', flexDirection:'column' }},
      React.createElement('input', { ref: fileInput, type: 'file', accept: 'image/*,video/*', onChange: handleFile, style: { display:'none' }}),
      React.createElement('div', { style: { fontSize:32, color: 'var(--text)' }}, loading ? '‚è≥' : '‚ûï'),
      React.createElement('div', { style: { fontSize:13, fontWeight:600, marginTop:8, color: 'var(--text)' }}, t('create'))
    );
  }

  function StoryCard({ story }) {
    const [author, setAuthor] = useState(null);
    useEffect(() => {
      (async () => {
        const prof = await getUserProfile(story.uid);
        setAuthor(prof);
      })();
    }, [story.uid]);
    return React.createElement('div', { className: 'story-circle', onClick: () => window.open(story.mediaUrl, '_blank') },
      React.createElement('img', { src: story.mediaUrl }),
      author?.avatarUrl && React.createElement('img', { src: author.avatarUrl, className: 'story-avatar' }),
      React.createElement('div', { className: 'story-label' }, author?.displayName || 'User')
    );
  }

  function ComposerModal({ t, user, onClose }) {
    const [text, setText] = useState('');
    const [file, setFile] = useState(null);
    const [loading, setLoading] = useState(false);
    async function submit(e) {
      e?.preventDefault();
      if (!text && !file) return;
      setLoading(true);
      try {
        let media = null;
        if (file) {
          const res = await uploadToCloudinary(file);
          media = { url: res.secure_url, type: res.resource_type || 'image' };
        }
        await createPost({ authorId: user.uid, content: text, media });
        onClose();
      } catch { alert('‚ùå Failed'); } finally { setLoading(false); }
    }
    return React.createElement('div', { className: 'modal', onClick: onClose },
      React.createElement('div', { className: 'modal-content', onClick: e => e.stopPropagation() },
        React.createElement('h3', { style: { marginBottom:20 }}, t('createPost')),
        React.createElement('form', { onSubmit: submit, className: 'col' },
          React.createElement('textarea', { placeholder: t('whatsOnYourMind'), value: text, onInput: e => setText(e.target.value), style: { minHeight:120 }}),
          React.createElement('input', { type: 'file', accept: 'image/*,video/*', onChange: e => setFile(e.target.files?.[0]) }),
          React.createElement('div', { className: 'row', style: { gap:12 }},
            React.createElement('button', { className: 'btn', type: 'submit', disabled: loading, style: { flex:1 }}, loading ? t('posting') : t('post')),
            React.createElement('button', { className: 'btn-ghost', type: 'button', onClick: onClose, style: { flex:1 }}, t('cancel'))
          )
        )
      )
    );
  }

  function EditProfileModal({ t, profile, onClose }) {
    const [form, setForm] = useState({
      displayName: profile?.displayName || '',
      bio: profile?.bio || '',
      status: profile?.status || ''
    });
    const [loading, setLoading] = useState(false);

    async function submit(e) {
      e.preventDefault();
      setLoading(true);
      try {
        await updateDoc(doc(db, 'users', profile.id), {
          ...form,
          displayNameLower: form.displayName.toLowerCase()
        });
        onClose(true);
      } catch (err) {
        console.error("Failed to update profile", err);
        alert('‚ùå Update failed');
      } finally {
        setLoading(false);
      }
    }

    return React.createElement('div', { className: 'modal', onClick: onClose },
      React.createElement('div', { className: 'modal-content', onClick: e => e.stopPropagation() },
        React.createElement('h3', { style: { marginBottom:20 }}, t('editProfile')),
        React.createElement('form', { onSubmit: submit, className: 'col' },
          React.createElement('label', { className: 'small' }, t('fullName')),
          React.createElement('input', {
            value: form.displayName,
            onInput: e => setForm(f => ({ ...f, displayName: e.target.value })),
            required: true
          }),
          React.createElement('label', { className: 'small' }, t('aboutYou')),
          React.createElement('textarea', {
            placeholder: 'Tell us about yourself...',
            value: form.bio,
            onInput: e => setForm(f => ({ ...f, bio: e.target.value }))
          }),
          React.createElement('label', { className: 'small' }, 'Status'),
          React.createElement('input', {
            placeholder: t('whatsOnYourMind'),
            value: form.status,
            onInput: e => setForm(f => ({ ...f, status: e.target.value }))
          }),
          React.createElement('div', { className: 'row', style: { gap:12, marginTop: 12 }},
            React.createElement('button', { className: 'btn', type: 'submit', disabled: loading, style: { flex:1 }}, loading ? t('posting') : t('save')),
            React.createElement('button', { className: 'btn-ghost', type: 'button', onClick: onClose, style: { flex:1 }}, t('cancel'))
          )
        )
      )
    );
  }


  function PostCard({ t, post, currentUser, onNavToProfile }) {
    const [author, setAuthor] = useState(null);
    const [showComments, setShowComments] = useState(false);
    const [commentText, setCommentText] = useState('');
    const [commentsWithAuthors, setCommentsWithAuthors] = useState([]);

    const liked = post.likes?.includes(currentUser?.uid);
    const isMine = currentUser?.uid === post.authorId;

    const realLikeCount = post.likes?.length || 0;
    const realCommentCount = post.comments?.length || 0;
    const displayLikes = post.displayLikeCount || realLikeCount;
    const displayComments = post.displayCommentCount || realCommentCount;
    const showRelevantMsg = post.displayCommentCount && post.displayCommentCount != realCommentCount;

    useEffect(() => {
      (async () => {
        const prof = await getUserProfile(post.authorId);
        setAuthor(prof);
      })();
    }, [post.authorId]);

    useEffect(() => {
      if (post.comments?.length > 0) {
        (async () => {
          const authors = {};
          const comments = await Promise.all(post.comments.map(async c => {
            if (!authors[c.uid]) {
              authors[c.uid] = await getUserProfile(c.uid);
            }
            return { ...c, author: authors[c.uid] };
          }));
          setCommentsWithAuthors(comments.reverse());
        })();
      } else {
        setCommentsWithAuthors([]);
      }
    }, [post.comments]);

    async function handleLike() {
      if (!currentUser) return;
      await toggleLike(post.id, currentUser.uid);
    }

    async function submitComment() {
      if (!commentText.trim() || !currentUser) return;
      const newComment = {
        uid: currentUser.uid,
        text: commentText,
        author: await getUserProfile(currentUser.uid),
        createdAt: new Date().toISOString()
      };
      setCommentsWithAuthors([newComment, ...commentsWithAuthors]);
      setCommentText('');
      await addComment(post.id, currentUser.uid, commentText);
    }

    async function handleDelete() {
      if (!confirm('Delete?')) return;
      try {
        await deletePost(post.id);
      } catch (err) {
        console.error('Delete failed', err);
        alert('‚ùå ' + err.message);
      }
    }

    return React.createElement('div', { className: 'card' },
      React.createElement('div', { className: 'row', style: { justifyContent:'space-between', marginBottom:12 }},
        React.createElement('div', {
          className: 'row',
          onClick: () => onNavToProfile(post.authorId),
          style: { cursor: 'pointer' }
        },
          React.createElement('img', { src: author?.avatarUrl || 'https://via.placeholder.com/40', className: 'avatar-lg' }),
          React.createElement('div', null,
            React.createElement('div', { style: { fontWeight:600, fontSize:15 }},
              author?.displayName || 'User',
              author?.verified && React.createElement('span', {
                title: 'Verified',
                style: { marginLeft: 6, verticalAlign: 'middle' },
                dangerouslySetInnerHTML: {
                  __html: '<svg viewBox="0 0 24 24" style="width:16px;height:16px;fill:#1D9BF0" xmlns="http://www.w3.org/2000/svg"><path d="M22.5 12.5c0-.9-.3-1.7-.8-2.4.3-.8.4-1.6.2-2.4-.2-.8-.7-1.5-1.3-2-.6-.5-1.4-.8-2.2-.9-.3-.7-.8-1.4-1.5-1.9-.7-.5-1.5-.8-2.4-.8s-1.7.3-2.4.8c-.7-.5-1.5-.8-2.4-.8s-1.7.3-2.4.8c-.7.5-1.2 1.2-1.5 1.9-.8.1-1.6.4-2.2.9-.6.5-1.1 1.2-1.3 2-.2.8-.1 1.6.2 2.4-.5.7-.8 1.5-.8 2.4s.3 1.7.8 2.4c-.3.8-.4 1.6-.2 2.4.2.8.7 1.5 1.3 2 .6.5 1.4.8 2.2.9.3.7.8 1.4 1.5 1.9.7.5 1.5.8 2.4.8s-1.7-.3 2.4-.8c.7.5 1.5.8 2.4.8s-1.7-.3 2.4-.8c.7-.5 1.2-1.2 1.5-1.9.8-.1 1.6-.4-2.2-.9.6-.5 1.1 1.2-1.3 2 .2-.8.1-1.6-.2-2.4.5-.7.8-1.5.8-2.4z"/><path fill="#fff" d="M10.8 14.9l-2.8-2.8 1.2-1.2 1.6 1.6 3.7-4 1.2 1.1z"/></svg>'
                }
              })
            ),
            React.createElement('div', { className: 'small' }, fmtDate(post.createdAt))
          )
        ),
        isMine && React.createElement('button', { className: 'btn-ghost', onClick: handleDelete, style: { padding:'6px 12px', color:'#fa3e3e' }}, 'üóëÔ∏è')
      ),
      post.content && React.createElement('p', { style: { margin:'12px 0', fontSize:15, lineHeight:1.4 }}, post.content),
      post.media && (post.media.type?.startsWith('video') ?
        React.createElement('video', { src: post.media.url, controls: true, className: 'post-media' }) :
        React.createElement('img', { src: post.media.url, className: 'post-media' })
      ),
      React.createElement('div', { style: { display:'flex', gap:8, marginTop:12, paddingTop:12, borderTop:'1px solid var(--hover)' }},
        React.createElement('div', { className: `like-btn ${liked ? 'liked' : ''}`, onClick: handleLike },
          React.createElement('span', { style: { fontSize:20 }}, liked ? '‚ù§Ô∏è' : 'ü§ç'),
          React.createElement('span', null, displayLikes)
        ),
        React.createElement('div', { className: 'like-btn', onClick: () => setShowComments(!showComments) },
          React.createElement('span', { style: { fontSize:20 }}, 'üí¨'),
          React.createElement('span', null, displayComments)
        )
      ),
      showComments && React.createElement('div', { className: 'comment-section' },
        showRelevantMsg && React.createElement('div', { className: 'small', style: { textAlign: 'center', marginBottom: 12, fontStyle: 'italic' }}, t('relevantComments')),
        React.createElement('div', { className: 'row', style: { marginBottom:12 }},
          React.createElement('input', { placeholder: t('comment'), value: commentText, onInput: e => setCommentText(e.target.value), onKeyPress: e => e.key === 'Enter' && submitComment() }),
          React.createElement('button', { className: 'btn', onClick: submitComment, style: { padding:'8px 16px' }}, '‚û§')
        ),
        commentsWithAuthors.map((c, i) => React.createElement('div', { key: c.createdAt + i, className: 'comment-item' },
          React.createElement('div', null,
            React.createElement('div', { className: 'comment-author', onClick: () => onNavToProfile(c.uid) }, c.author?.displayName || 'User'),
            React.createElement('div', null, c.text)
          )
        ))
      )
    );
  }

  function FriendsPage({ t, user, onNavToProfile }) {
    const [requests, setRequests] = useState([]);
    const [friends, setFriends] = useState([]);

    useEffect(() => {
      (async () => {
        const reqs = await getFriendRequests(user.uid);
        setRequests(reqs);
      })();
    }, [user.uid]);

    useEffect(() => {
      (async () => {
        const frdIds = await getFriends(user.uid);
        const friendProfiles = await Promise.all(frdIds.map(id => getUserProfile(id)));
        setFriends(friendProfiles.filter(Boolean));
      })();
    }, [user.uid, requests]);


    async function accept(req) {
      await acceptFriendRequest(req.id);
      setRequests(requests.filter(r => r.id !== req.id));
    }

    async function decline(req) {
      await declineFriendRequest(req.id);
      setRequests(requests.filter(r => r.id !== req.id));
    }

    return React.createElement('div', null,
      React.createElement('div', { className: 'card' },
        React.createElement('h3', { style: { marginBottom:16 }}, `${t('requests')} (${requests.length})`),
        requests.length === 0 && React.createElement('div', { className: 'small' }, t('noRequests')),
        requests.map(req => React.createElement(FriendRequestCard, { key: req.id, t, request: req, onAccept: () => accept(req), onDecline: () => decline(req) }))
      ),
      React.createElement('div', { className: 'card' },
        React.createElement('h3', { style: { marginBottom:16 }}, `${t('friends')} (${friends.length})`),
        friends.length === 0 && React.createElement('div', { className: 'empty-state' },
          React.createElement('div', { className: 'empty-icon' }, 'üë•'),
          React.createElement('div', null, t('noFriends'))
        ),
        friends.map(f => React.createElement('div', { key: f.id, className: 'friend-card', style: { cursor: 'pointer' }, onClick: () => onNavToProfile(f.id) },
          React.createElement('div', { className: 'row' },
            React.createElement('img', { src: f.avatarUrl || 'https://via.placeholder.com/40', className: 'avatar-lg' }),
            React.createElement('div', null,
              React.createElement('div', { style: { fontWeight:600 }}, f.displayName)
            )
          )
        ))
      )
    );
  }

  function FriendRequestCard({ t, request, onAccept, onDecline }) {
    const [requester, setRequester] = useState(null);
    useEffect(() => {
      (async () => {
        const prof = await getUserProfile(request.requester);
        setRequester(prof);
      })();
    }, [request.requester]);

    if (!requester) return null;

    return React.createElement('div', { className: 'friend-card' },
      React.createElement('div', { className: 'row' },
        React.createElement('img', { src: requester.avatarUrl || 'https://via.placeholder.com/40', className: 'avatar-lg' }),
        React.createElement('div', null,
          React.createElement('div', { style: { fontWeight:600 }}, requester.displayName)
        )
      ),
      React.createElement('div', { className: 'row', style: { gap:8 }},
        React.createElement('button', { className: 'btn', onClick: onAccept }, t('accept')),
        React.createElement('button', { className: 'btn-ghost', onClick: onDecline }, t('decline'))
      )
    );
  }

  function ProfilePage({ t, uid, currentUser, userProfile, onNavToProfile }) {
    const [profile, setProfile] = useState(null);
    const [posts, setPosts] = useState([]);
    const [tab, setTab] = useState('posts');
    const [isUploading, setIsUploading] = useState(false);
    const [friendStatus, setFriendStatus] = useState(null);
    const [showEditModal, setShowEditModal] = useState(false);

    const profileId = uid || currentUser?.uid;
    const owner = currentUser && profileId === currentUser.uid;

    useEffect(() => {
      (async () => {
        if (profileId) {
          if (owner) {
            setProfile(userProfile);
          } else {
            const p = await getUserProfile(profileId);
            setProfile(p);
          }
          if (!owner && currentUser) {
            const status = await getFriendStatus(currentUser.uid, profileId);
            setFriendStatus(status);
          }
        }
      })();
    }, [profileId, currentUser, userProfile, owner]);

    useEffect(() => {
      if (!profileId) return;
      (async () => {
        // Removed orderBy here
        const q = query(collection(db, 'posts'), where('authorId', '==', profileId));
        const snap = await getDocs(q);
        // Sort manually in JS after fetching
        const fetchedPosts = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        fetchedPosts.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
        setPosts(fetchedPosts);
      })();
    }, [profileId, tab]);

    const refreshProfile = async () => {
      const p = await getUserProfile(profileId);
      setProfile(p);
    };

    async function sendRequest() {
      if (!currentUser || owner) return;
      setFriendStatus('pending');
      try {
        await sendFriendRequest(currentUser.uid, profileId);
        alert('‚úÖ Request sent!');
      } catch (err) {
        console.error(err);
        setFriendStatus(null);
      }
    }

    async function handleFileUpload(e, type) {
      const file = e.target.files?.[0];
      if (!file || !owner) return;
      setIsUploading(true);
      try {
        const res = await uploadToCloudinary(file);
        const url = res.secure_url;
        const key = type === 'avatar' ? 'avatarUrl' : 'coverUrl';
        await updateDoc(doc(db, 'users', currentUser.uid), { [key]: url });
        setProfile(p => ({ ...p, [key]: url }));
      } catch (err) {
        console.error('Upload failed', err);
        alert('‚ùå Upload failed');
      } finally {
        setIsUploading(false);
        if (e.target) e.target.value = null;
      }
    }

    function renderFriendButton() {
      if (owner) return null;
      if (friendStatus === 'accepted') {
        return React.createElement('button', { className: 'btn-ghost', disabled: true }, t('friendsDot'));
      }
      if (friendStatus === 'pending') {
        return React.createElement('button', { className: 'btn-ghost', disabled: true }, t('requestSent'));
      }
      return React.createElement('button', { className: 'btn', onClick: sendRequest }, t('addFriend'));
    }

    const avatarInputRef = useRef(null);
    const coverInputRef = useRef(null);

    if (!profile) return React.createElement('div', { className: 'card' }, t('loading'));

    return React.createElement('div', null,
      showEditModal && React.createElement(EditProfileModal, {
        t,
        profile,
        onClose: (didUpdate) => {
          setShowEditModal(false);
          if (didUpdate) refreshProfile();
        }
      }),

      owner && React.createElement('input', {
        type: 'file', ref: avatarInputRef, style: { display: 'none' }, accept: 'image/*',
        onChange: (e) => handleFileUpload(e, 'avatar')
      }),
      owner && React.createElement('input', {
        type: 'file', ref: coverInputRef, style: { display: 'none' }, accept: 'image/*',
        onChange: (e) => handleFileUpload(e, 'cover')
      }),

      React.createElement('div', { className: 'card', style: { padding:0, overflow:'hidden' }},
        React.createElement('div', { style: { position: 'relative' }},
          profile.coverUrl ? React.createElement('img', { src: profile.coverUrl, className: 'cover' }) : React.createElement('div', { className: 'cover' }),
          owner && React.createElement('button', {
            className: 'btn-ghost',
            style: { position: 'absolute', bottom: 12, right: 12, background: 'rgba(255,255,255,0.8)' },
            onClick: () => coverInputRef.current?.click(),
            disabled: isUploading
          }, isUploading ? '...' : `üì∑ ${t('edit')}`)
        ),
        React.createElement('div', { style: { padding:20, marginTop:-50 }},
          React.createElement('div', { className: 'row', style: { justifyContent:'space-between', alignItems:'flex-end' }},
            owner ?
              (!profile.avatarUrl ?
                React.createElement('div', { className: 'avatar-placeholder', onClick: () => avatarInputRef.current?.click() }, 'üì∑') :
                React.createElement('img', {
                  src: profile.avatarUrl,
                  className: 'avatar-lg',
                  style: { width:80, height:80, border:'5px solid var(--card)', cursor: 'pointer', borderRadius: '50%' },
                  onClick: () => avatarInputRef.current?.click()
                })
              ) :
              (!profile.avatarUrl ?
                React.createElement('div', { className: 'avatar-placeholder', style: { cursor: 'default' } }, 'üë§') :
                React.createElement('img', {
                  src: profile.avatarUrl,
                  className: 'avatar-lg',
                  style: { width:80, height:80, border:'5px solid var(--card)', borderRadius: '50%' }
                })
              ),
            owner ?
              React.createElement('button', {
                className: 'btn-ghost',
                onClick: () => setShowEditModal(true),
                disabled: isUploading
              }, isUploading ? t('posting') : t('editProfile')) :
              renderFriendButton()
          ),
          React.createElement('div', { style: { marginTop:16 }},
            React.createElement('h2', { style: { display: 'flex', alignItems: 'center', flexWrap: 'wrap' } },
              profile.displayName,
              profile.verified && React.createElement('span', {
                title: 'Verified',
                style: { marginLeft: 6, verticalAlign: 'middle', flexShrink: 0 },
                dangerouslySetInnerHTML: {
                  __html: '<svg viewBox="0 0 24 24" style="width:16px;height:16px;fill:#1D9BF0" xmlns="http://www.w3.org/2000/svg"><path d="M22.5 12.5c0-.9-.3-1.7-.8-2.4.3-.8.4-1.6.2-2.4-.2-.8-.7-1.5-1.3-2-.6-.5-1.4-.8-2.2-.9-.3-.7-.8-1.4-1.5-1.9-.7-.5-1.5-.8-2.4-.8s-1.7.3-2.4.8c-.7-.5-1.5-.8-2.4-.8s-1.7.3-2.4.8c-.7.5-1.2 1.2-1.5 1.9-.8.1-1.6.4-2.2.9-.6.5-1.1 1.2-1.3 2-.2.8-.1 1.6.2 2.4-.5.7-.8 1.5-.8 2.4s.3 1.7.8 2.4c-.3.8-.4 1.6-.2 2.4.2.8.7 1.5 1.3 2 .6.5 1.4.8 2.2.9.3.7.8 1.4 1.5 1.9.7.5 1.5.8 2.4.8s-1.7-.3 2.4-.8c.7.5 1.5.8 2.4.8s-1.7-.3 2.4-.8c.7-.5 1.2-1.2 1.5-1.9.8-.1 1.6-.4-2.2-.9.6-.5 1.1 1.2-1.3 2 .2-.8.1-1.6-.2-2.4.5-.7.8-1.5.8-2.4z"/><path fill="#fff" d="M10.8 14.9l-2.8-2.8 1.2-1.2 1.6 1.6 3.7-4 1.2 1.1z"/></svg>'
                }
              }),
              profile.followerCount && React.createElement('span', { className: 'followers-badge' }, `${profile.followerCount} followers`)
            ),
            profile.status && React.createElement('div', { style: { marginTop:12, padding:12, background:'var(--hover)', borderRadius:8, fontStyle:'italic' }}, profile.status)
          )
        ),
        React.createElement('div', { className: 'tabs' },
          React.createElement('div', { className: `tab ${tab === 'posts' ? 'active' : ''}`, onClick: () => setTab('posts') }, t('posts')),
          React.createElement('div', { className: `tab ${tab === 'about' ? 'active' : ''}`, onClick: () => setTab('about') }, t('about'))
        )
      ),
      tab === 'posts' && (
        posts.length === 0 ?
          React.createElement('div', { className: 'empty-state' },
            React.createElement('div', { className: 'empty-icon' }, 'üìù'),
            React.createElement('div', null, t('noPostsYet'))
          ) :
          posts.map(p => React.createElement(PostCard, { t, key: p.id, post: p, currentUser: currentUser, onNavToProfile: onNavToProfile }))
      ),
      tab === 'about' && React.createElement('div', { className: 'card' },
        React.createElement('h4', { style: { marginBottom: 12 }}, t('aboutYou')),
        profile.bio ?
          React.createElement('p', { style: { lineHeight: 1.5, whiteSpace: 'pre-wrap' }}, profile.bio) :
          React.createElement('div', { className: 'small' }, t('noBio'))
      )
    );
  }

  function MessagesPage({ t, currentUser, onNavToProfile, unreadMap }) {
    const [friends, setFriends] = useState([]);
    const [loading, setLoading] = useState(true);
    const [searchTerm, setSearchTerm] = useState('');
    const [selectedChat, setSelectedChat] = useState(null);

    useEffect(() => {
      (async () => {
        setLoading(true);
        const frdIds = await getFriends(currentUser.uid);
        const friendProfiles = await Promise.all(frdIds.map(id => getUserProfile(id)));
        setFriends(friendProfiles.filter(Boolean));
        setLoading(false);
      })();
    }, [currentUser.uid]);

    if (selectedChat) {
      const chatId = getChatId(currentUser.uid, selectedChat.uid);
      return React.createElement(ChatWindow, {
        t,
        currentUser,
        chatId,
        targetUser: selectedChat,
        onBack: () => setSelectedChat(null),
        onBlock: () => {
          setFriends(friends.filter(f => f.id !== selectedChat.uid));
          setSelectedChat(null);
        }
      });
    }

    const filteredFriends = friends.filter(f =>
      f.displayName.toLowerCase().includes(searchTerm.toLowerCase())
    );

    return React.createElement('div', { className: 'card' },
      React.createElement('h3', null, t('messages')),
      React.createElement('input', {
        className: 'search-input',
        placeholder: t('searchFriends'),
        value: searchTerm,
        onInput: e => setSearchTerm(e.target.value),
        style: { width: '100%', margin: '16px 0', background: 'var(--bg)' }
      }),
      loading && React.createElement('div', { className: 'small' }, t('loading')),
      !loading && friends.length === 0 && React.createElement('div', { className: 'empty-state' },
        React.createElement('div', { className: 'empty-icon' }, 'üí¨'),
        React.createElement('div', null, t('noFriendsMessage'))
      ),
      !loading && filteredFriends.length === 0 && friends.length > 0 && React.createElement('div', { className: 'small' }, t('noFriendsFound')),
      filteredFriends.map(f => {
        const chatId = getChatId(currentUser.uid, f.id);
        const unreadCount = unreadMap[chatId] || 0;

        return React.createElement('div', {
          key: f.id,
          className: 'friend-item-card',
          onClick: () => setSelectedChat({ uid: f.id, displayName: f.displayName, avatarUrl: f.avatarUrl })
        },
          React.createElement('img', { src: f.avatarUrl || 'https://via.placeholder.com/40', className: 'avatar-lg' }),
          React.createElement('div', null,
            React.createElement('div', { style: { fontWeight:600 }}, f.displayName),
            React.createElement('div', { className: 'small' }, t('startConversation'))
          ),
          unreadCount > 0 && React.createElement('div', { className: 'notif-badge' }, unreadCount)
        );
      })
    );
  }

  function ChatWindow({ t, currentUser, chatId, targetUser, onBack, onBlock }) {
    const [messages, setMessages] = useState([]);
    const [newMessage, setNewMessage] = useState('');
    const [chatData, setChatData] = useState(null);
    const [showMenu, setShowMenu] = useState(false);
    const [isUploading, setIsUploading] = useState(false);
    const [unsendModal, setUnsendModal] = useState(null);
    const messagesEndRef = useRef(null);
    const mediaInputRef = useRef(null);
    const bgInputRef = useRef(null);

    const [pressTimer, setPressTimer] = useState(null);

    useEffect(() => {
      clearUnreadCount(chatId, currentUser.uid);

      const unsub = subscribeMessages(chatId, setMessages);
      const unsubData = subscribeChatData(chatId, setChatData);
      return () => { unsub(); unsubData(); };
    }, [chatId, currentUser.uid]);

    useEffect(() => {
      messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
    }, [messages]);

    async function handleSend(e) {
      e.preventDefault();
      if (!newMessage.trim()) return;
      const msg = newMessage;
      setNewMessage('');
      try {
        await sendMessage(chatId, currentUser.uid, targetUser.uid, { text: msg, media: null });
      } catch (err) {
        console.error('Message send failed:', err);
        alert('‚ùå ' + err.message);
        setNewMessage(msg);
      }
    }

    async function handleMediaUpload(e) {
      const file = e.target.files?.[0];
      if (!file) return;
      setIsUploading(true);
      try {
        const res = await uploadToCloudinary(file);
        await sendMessage(chatId, currentUser.uid, targetUser.uid, {
          text: null,
          media: { url: res.secure_url, type: res.resource_type }
        });
      } catch (err) {
        console.error('Media upload failed:', err);
        alert('‚ùå ' + err.message);
      } finally {
        setIsUploading(false);
        if (e.target) e.target.value = null;
      }
    }

    async function handleBackgroundUpload(e) {
      const file = e.target.files?.[0];
      if (!file) return;
      setShowMenu(false);
      setIsUploading(true);
      try {
        const res = await uploadToCloudinary(file);
        await updateDoc(doc(db, 'chats', chatId), {
          [currentUser.uid + '_bg']: res.secure_url
        });
      } catch (err) {
        console.error('BG upload failed:', err);
        alert('‚ùå ' + err.message);
      } finally {
        setIsUploading(false);
        if (e.target) e.target.value = null;
      }
    }

    async function handleClearBg() {
      setShowMenu(false);
      await updateDoc(doc(db, 'chats', chatId), {
        [currentUser.uid + '_bg']: ''
      });
    }

    async function handleUnsend() {
      if (!unsendModal) return;
      const msgId = unsendModal.id;
      setUnsendModal(null);
      try {
        await unsendMessage(chatId, msgId);
      } catch (err) {
        console.error('Unsend failed:', err);
        alert('‚ùå ' + err.message);
      }
    }

    async function handleBlock() {
      setShowMenu(false);
      if (!confirm(`Block ${targetUser.displayName}? This will also unfriend them.`)) return;
      try {
        await blockUser(currentUser.uid, targetUser.uid);
        alert(`‚úÖ ${targetUser.displayName} blocked.`);
        onBlock();
      } catch (err) {
        console.error('Block failed:', err);
        alert('‚ùå ' + err.message);
      }
    }

    const handleTouchStart = (msg) => {
      const timer = setTimeout(() => {
        setUnsendModal(msg);
      }, 500);
      setPressTimer(timer);
    };
    const handleTouchEnd = () => { clearTimeout(pressTimer); };
    const handleTouchMove = () => { clearTimeout(pressTimer); };

    const myBg = chatData?.[currentUser.uid + '_bg'];

    return React.createElement('div', {
      className: 'card chat-page',
      style: { backgroundImage: myBg ? `url(${myBg})` : 'none' }
    },
      React.createElement('input', { type: 'file', ref: mediaInputRef, style: { display: 'none' }, accept: 'image/*,video/*', onChange: handleMediaUpload }),
      React.createElement('input', { type: 'file', ref: bgInputRef, style: { display: 'none' }, accept: 'image/*', onChange: handleBackgroundUpload }),

      unsendModal && React.createElement(UnsendModal, { t, onCancel: () => setUnsendModal(null), onConfirm: handleUnsend }),

      React.createElement('div', { className: 'chat-header' },
        React.createElement('button', { className: 'btn-ghost', onClick: onBack, style: { padding: '8px' }}, '‚¨ÖÔ∏è'),
        React.createElement('img', { src: targetUser.avatarUrl || 'https://via.placeholder.com/40', className: 'avatar' }),
        React.createElement('div', { style: { fontWeight: 600, marginRight: 'auto' }}, targetUser.displayName),
        React.createElement('button', { className: 'btn-ghost', onClick: () => setShowMenu(!showMenu), style: { padding: '8px' }}, '...'),
        showMenu && React.createElement('div', { className: 'chat-menu' },
          React.createElement('div', { className: 'chat-menu-item', onClick: () => bgInputRef.current.click() }, t('changeBg')),
          React.createElement('div', { className: 'chat-menu-item', onClick: handleClearBg }, t('clearBg')),
          React.createElement('div', { className: 'chat-menu-item danger', onClick: handleBlock }, t('blockUser', { name: targetUser.displayName }))
        )
      ),
      React.createElement('div', { className: 'chat-messages' },
        React.createElement('div', { ref: messagesEndRef }),
        messages.map(msg => {
          const isSent = msg.from === currentUser.uid;
          return React.createElement('div', {
            key: msg.id,
            className: `chat-message-item ${isSent ? 'sent' : 'received'}`,
            onTouchStart: () => isSent && handleTouchStart(msg),
            onTouchEnd: handleTouchEnd,
            onTouchMove: handleTouchMove,
            onMouseDown: (e) => isSent && handleTouchStart(msg),
            onMouseUp: handleTouchEnd,
            onMouseLeave: handleTouchEnd
          },
            React.createElement('div', { className: 'chat-bubble' },
              msg.text,
              msg.media && React.createElement('img', {
                src: msg.media.url,
                onClick: (e) => { e.stopPropagation(); window.open(msg.media.url, '_blank'); },
                style: { cursor: 'pointer' }
              })
            )
          );
        })
      ),
      React.createElement('form', { className: 'chat-input-box', onSubmit: handleSend },
        React.createElement('button', {
          className: 'btn-ghost',
          type: 'button',
          onClick: () => mediaInputRef.current.click(),
          disabled: isUploading,
          style: { padding: '10px' }
        }, isUploading ? '‚è≥' : 'üì∑'),
        React.createElement('input', {
          placeholder: t('typeMessage'),
          value: newMessage,
          onInput: e => setNewMessage(e.target.value),
          style: { background: 'var(--bg)' },
          disabled: isUploading
        }),
        React.createElement('button', { className: 'btn', type: 'submit', style: { padding: '10px 16px' }, disabled: isUploading }, '‚û§')
      )
    );
  }

  function BlockedListModal({ t, currentUser, onClose }) {
    const [blockedUsers, setBlockedUsers] = useState([]);
    const [loading, setLoading] = useState(true);

    useEffect(() => {
      (async () => {
        setLoading(true);
        const blocksQuery = query(collection(db, 'blocks'), where('by', '==', currentUser.uid));
        const blocksSnap = await getDocs(blocksQuery);
        const blocksData = blocksSnap.docs.map(d => ({ id: d.id, ...d.data() }));

        const profiles = await Promise.all(
          blocksData.map(block => getUserProfile(block.for))
        );

        const usersWithBlockId = profiles.map((profile, index) => ({
          ...profile,
          blockId: blocksData[index].id
        })).filter(Boolean);

        setBlockedUsers(usersWithBlockId);
        setLoading(false);
      })();
    }, [currentUser.uid]);

    async function handleUnblock(targetUser) {
      try {
        await unblockUser(currentUser.uid, targetUser.id);
        setBlockedUsers(currentList => currentList.filter(u => u.id !== targetUser.id));
        alert(`‚úÖ ${targetUser.displayName} unblocked.`);
      } catch (err) {
        console.error('Unblock failed:', err);
        alert('‚ùå Unblock failed.');
      }
    }

    return React.createElement('div', { className: 'modal', onClick: onClose },
      React.createElement('div', { className: 'modal-content', onClick: e => e.stopPropagation() },
        React.createElement('h3', { style: { marginBottom: 20 }}, t('blockedUsers')),
        loading && React.createElement('div', { className: 'small' }, t('loading')),
        !loading && blockedUsers.length === 0 && React.createElement('div', { className: 'empty-state', style: { padding: '20px 0'} },
           React.createElement('div', { className: 'empty-icon' }, 'üö´'),
           React.createElement('div', null, t('noBlockedUsers'))
        ),
        !loading && blockedUsers.map(user =>
          React.createElement('div', { key: user.id, className: 'friend-card' },
            React.createElement('div', { className: 'row' },
              React.createElement('img', { src: user.avatarUrl || 'https://via.placeholder.com/40', className: 'avatar' }),
              React.createElement('div', { style: { fontWeight: 600 }}, user.displayName)
            ),
            React.createElement('button', {
              className: 'btn-ghost',
              style: { color: '#fa3e3e'},
              onClick: () => handleUnblock(user)
            }, t('unblock'))
          )
        ),
        React.createElement('button', {
          className: 'btn-secondary',
          onClick: onClose,
          style: { marginTop: 20, width: '100%'}
        }, t('close'))
      )
    );
  }

  function SettingsPage({ t, lang, setLang, theme, setTheme, currentUser, onShowBlocked }) {
    const [supportForm, setSupportForm] = useState({ email: currentUser.email || '', message: '' });
    const [supportMsg, setSupportMsg] = useState('');
    const [loading, setLoading] = useState(false);
    
    async function handleSupportSubmit(e) {
      e.preventDefault();
      if (!supportForm.email || !supportForm.message) return;
      setLoading(true);
      setSupportMsg('');
      try {
        await addDoc(collection(db, 'supportTickets'), {
          ...supportForm,
          from: currentUser.uid,
          createdAt: serverTimestamp()
        });
        setSupportMsg(t('messageSent'));
        setSupportForm({ email: currentUser.email || '', message: '' });
      } catch (err) {
        console.error('Support ticket failed', err);
        setSupportMsg(t('messageFailed'));
      } finally {
        setLoading(false);
      }
    }
    
    return React.createElement('div', null,
      React.createElement('div', { className: 'card' },
        React.createElement('h3', { style: { marginBottom:20 }}, t('settings')),
        React.createElement('div', { className: 'col' },
          React.createElement('label', { className: 'small' }, t('language')),
          React.createElement('select', { value: lang, onChange: e => setLang(e.target.value) },
            React.createElement('option', { value: 'en' }, 'English'),
            React.createElement('option', { value: 'yo' }, 'Yoruba'),
            React.createElement('option', { value: 'es' }, 'Espa√±ol (Spanish)'),
            React.createElement('option', { value: 'it' }, 'Italiano (Italian)'),
            React.createElement('option', { value: 'fr' }, 'Fran√ßais (French)'),
            React.createElement('option', { value: 'de' }, 'Deutsch (German)')
        ),
        React.createElement('div', { className: 'row', style: { alignItems:'center', justifyContent:'space-between', marginTop:16 } },
          React.createElement('span', null, t('darkMode')),
          React.createElement('button', { className: 'btn-ghost', onClick: () => setTheme(theme === 'light' ? 'dark' : 'light') }, theme === 'light' ? `üåû ${t('light')}` : `üåô ${t('dark')}`)
        ),
        React.createElement('button', {
          className: 'btn-secondary',
          onClick: onShowBlocked,
          style: { marginTop: 16, width: '100%' }
        }, t('blockedUsers')),

        React.createElement('button', { className: 'btn', onClick: async () => { await signOut(auth); window.location.reload(); }, style: { marginTop:20, background:'#fa3e3e' }}, t('logout'))
        )
      ),
      React.createElement('div', { className: 'card' },
        React.createElement('h4', null, t('helpSupport')),
        React.createElement('form', { onSubmit: handleSupportSubmit, className: 'col', style: { marginTop: 12 }},
          React.createElement('input', {
            placeholder: t('yourEmail'),
            type: 'email',
            value: supportForm.email,
            onInput: e => setSupportForm(f => ({ ...f, email: e.target.value })),
            required: true
          }),
          React.createElement('textarea', {
            placeholder: t('yourMessage'),
            value: supportForm.message,
            onInput: e => setSupportForm(f => ({ ...f, message: e.target.value })),
            required: true
          }),
          React.createElement('button', { className: 'btn', type: 'submit', disabled: loading }, loading ? t('posting') : t('submit')),
          supportMsg && React.createElement('div', { 
            className: 'small', 
            style: { 
              textAlign: 'center', 
              color: supportMsg.startsWith('‚ùå') ? '#fa3e3e' : 'green',
              marginTop: 8
            }
          }, supportMsg)
        )
      )
    );
  }

  function AdminPage({ t, currentUser }) {
    const [tab, setTab] = useState('users');
    
    return React.createElement('div', { className: 'card' },
      React.createElement('h3', { style: { marginBottom:0 }}, t('admin')),
      React.createElement('div', { className: 'tabs' },
        React.createElement('div', { className: `tab ${tab === 'users' ? 'active' : ''}`, onClick: () => setTab('users') }, t('manageUsers')),
        React.createElement('div', { className: `tab ${tab === 'posts' ? 'active' : ''}`, onClick: () => setTab('posts') }, t('managePosts'))
      ),
      tab === 'users' && React.createElement(AdminManageUsers, { t }),
      tab === 'posts' && React.createElement(AdminManagePosts, { t })
    );
  }
  
  function AdminManageUsers({ t }) {
    const [users, setUsers] = useState([]);
    const [followerInputs, setFollowerInputs] = useState({});
    
    useEffect(() => {
      (async () => {
        const q = query(collection(db,'users'), orderBy('createdAt','desc'));
        const snap = await getDocs(q);
        setUsers(snap.docs.map(d => ({ id: d.id, ...d.data() })));
      })();
    }, []);
    
    async function toggleVerified(uid, current) {
      try {
        await updateDoc(doc(db,'users',uid), { verified: !current });
        setUsers(u => u.map(x => x.id === uid ? { ...x, verified: !current } : x));
      } catch (err) {
        console.error('Verify failed:', err);
        alert('‚ùå ' + err.message);
      }
    }
    
    async function saveFollowerCount(uid) {
      const count = followerInputs[uid] || '';
      try {
        await updateDoc(doc(db,'users',uid), { followerCount: count });
        setUsers(u => u.map(x => x.id === uid ? { ...x, followerCount: count } : x));
        setFollowerInputs(f => ({ ...f, [uid]: undefined }));
        alert('‚úÖ Saved!');
      } catch (err) {
        console.error('Save follower count failed:', err);
        alert('‚ùå ' + err.message);
      }
    }
    
    return React.createElement('div', null,
      React.createElement('p', { className: 'small', style: { marginBottom:16 }}, t('verifyUsersMessage')),
      users.map(u => React.createElement('div', { key: u.id, className: 'card', style: { background: 'var(--hover)' } },
        React.createElement('div', { className: 'row', style: { justifyContent: 'space-between' }},
          React.createElement('div', { className: 'row' },
            u.avatarUrl && React.createElement('img', { src: u.avatarUrl, className: 'avatar' }),
            React.createElement('div', null,
              React.createElement('div', { style: { fontWeight:600 }}, 
                u.displayName,
                u.verified && React.createElement('span', { 
                  title: 'Verified', 
                  style: { marginLeft: 6, verticalAlign: 'middle' }, 
                  dangerouslySetInnerHTML: { 
                    __html: '<svg viewBox="0 0 24 24" style="width:16px;height:16px;fill:#1D9BF0" xmlns="http://www.w3.org/2000/svg"><path d="M22.5 12.5c0-.9-.3-1.7-.8-2.4.3-.8.4-1.6.2-2.4-.2-.8-.7-1.5-1.3-2-.6-.5-1.4-.8-2.2-.9-.3-.7-.8-1.4-1.5-1.9-.7-.5-1.5-.8-2.4-.8s-1.7.3-2.4.8c-.7-.5-1.5-.8-2.4-.8s-1.7.3-2.4.8c-.7.5-1.2 1.2-1.5 1.9-.8.1-1.6.4-2.2.9-.6.5-1.1 1.2-1.3 2-.2.8-.1 1.6.2 2.4-.5.7-.8 1.5-.8 2.4s.3 1.7.8 2.4c-.3.8-.4 1.6-.2 2.4.2.8.7 1.5 1.3 2 .6.5 1.4.8 2.2.9.3.7.8 1.4 1.5 1.9.7.5 1.5.8 2.4.8s-1.7-.3 2.4-.8c.7.5 1.5.8 2.4.8s-1.7-.3 2.4-.8c.7-.5 1.2-1.2 1.5-1.9.8-.1 1.6-.4-2.2-.9.6-.5 1.1 1.2-1.3 2 .2-.8.1-1.6-.2-2.4.5-.7.8-1.5.8-2.4z"/><path fill="#fff" d="M10.8 14.9l-2.8-2.8 1.2-1.2 1.6 1.6 3.7-4 1.2 1.1z"/></svg>' 
                  }
                }),
                u.followerCount && React.createElement('span', { className: 'followers-badge' }, u.followerCount)
              )
            )
          ),
          React.createElement('button', { 
            className: u.verified ? 'btn-ghost' : 'btn', 
            onClick: () => toggleVerified(u.id, u.verified), 
            style: u.verified ? { color:'#fa3e3e', padding:'6px 12px' } : { padding:'6px 12px' }
          }, u.verified ? t('removeVerify') : t('verify'))
        ),
        React.createElement('div', { className: 'row', style: { marginTop: 12 }},
          React.createElement('input', { 
            placeholder: t('followerCountPlaceholder'),
            value: followerInputs[u.id] !== undefined ? followerInputs[u.id] : (u.followerCount || ''),
            onInput: e => setFollowerInputs(f => ({ ...f, [u.id]: e.target.value })),
            style: { fontSize: 13, padding: 8 }
          }),
          React.createElement('button', { 
            className: 'btn-ghost', 
            onClick: () => saveFollowerCount(u.id),
            style: { padding: '8px 12px' }
          }, t('save'))
        )
      ))
    );
  }
  
  function AdminManagePosts({ t }) {
    const [posts, setPosts] = useState([]);
    const [postInputs, setPostInputs] = useState({});
    
    useEffect(() => {
      (async () => {
        const q = query(collection(db,'posts'), orderBy('createdAt','desc'));
        const snap = await getDocs(q);
        setPosts(snap.docs.map(d => ({ id: d.id, ...d.data() })));
      })();
    }, []);
    
    async function savePostCounts(postId) {
      const inputs = postInputs[postId] || {};
      const data = {
        displayLikeCount: inputs.displayLikes !== undefined ? inputs.displayLikes : '',
        displayCommentCount: inputs.displayComments !== undefined ? inputs.displayComments : ''
      };
      await updateDoc(doc(db,'posts', postId), data);
      setPosts(p => p.map(x => x.id === postId ? { ...x, ...data } : x));
      setPostInputs(f => ({ ...f, [postId]: undefined }));
      alert('‚úÖ Saved!');
    }
    
    return React.createElement('div', null,
      React.createElement('p', { className: 'small', style: { marginBottom:16 }}, t('managePostsMessage')),
      posts.map(p => React.createElement('div', { key: p.id, className: 'card', style: { background: 'var(--hover)' } },
        React.createElement('p', { className: 'small', style: { fontStyle: 'italic' }}, p.content ? `"${p.content.substring(0,100)}..."` : '(Media post)'),
        React.createElement('div', { className: 'row', style: { marginTop: 12, gap: 8 }},
          React.createElement('input', { 
            placeholder: t('likesReal', { count: p.likes.length }),
            value: postInputs[p.id]?.displayLikes !== undefined ? postInputs[p.id].displayLikes : (p.displayLikeCount || ''),
            onInput: e => setPostInputs(f => ({ ...f, [p.id]: { ...f[p.id], displayLikes: e.target.value } })),
            style: { fontSize: 13, padding: 8 }
          }),
          React.createElement('input', { 
            placeholder: t('commentsReal', { count: p.comments.length }),
            value: postInputs[p.id]?.displayComments !== undefined ? postInputs[p.id].displayComments : (p.displayCommentCount || ''),
            onInput: e => setPostInputs(f => ({ ...f, [p.id]: { ...f[p.id], displayComments: e.target.value } })),
            style: { fontSize: 13, padding: 8 }
          })
        ),
        React.createElement('button', { 
          className: 'btn', 
          onClick: () => savePostCounts(p.id),
          style: { padding: '8px 16px', marginTop: 8, width: '100%' }
        }, t('saveCounts'))
      ))
    );
  }
// --- START OF NEW GAME CODE ---
  
  // Helper function to check for a winner
  function checkWinner(board) {
    const lines = [
      [0, 1, 2], [3, 4, 5], [6, 7, 8], // rows
      [0, 3, 6], [1, 4, 7], [2, 5, 8], // cols
      [0, 4, 8], [2, 4, 6]  // diagonals
    ];
    for (let line of lines) {
      const [a, b, c] = line;
      if (board[a] && board[a] === board[b] && board[a] === board[c]) {
        return board[a]; // 'X' or 'O'
      }
    }
    if (board.every(cell => cell !== null)) {
      return 'T'; // Tie
    }
    return null;
  }

  // New Component: Game Lobby
  function GameLobby({ t, user, userProfile, onJoinGame }) {
    const [openGames, setOpenGames] = useState([]);
    const [loading, setLoading] = useState(false);

    useEffect(() => {
      const q = query(collection(db, 'games'), where('status', '==', 'waiting'));
      const unsubscribe = onSnapshot(q, (snapshot) => {
        setOpenGames(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
      });
      return () => unsubscribe();
    }, []);

    async function createGame() {
      setLoading(true);
      try {
        const newGame = {
          board: Array(9).fill(null),
          players: [user.uid], // Player 'X'
          playerNames: { [user.uid]: userProfile.displayName || 'Player 1' },
          status: 'waiting', // 'waiting', 'playing', 'finished'
          nextTurn: user.uid,
          createdAt: serverTimestamp()
        };
        const gameRef = await addDoc(collection(db, 'games'), newGame);
        onJoinGame(gameRef.id);
      } catch (err) {
        console.error("Error creating game:", err);
      }
      setLoading(false);
    }

    async function joinGame(gameId, existingGame) {
      setLoading(true);
      try {
        const gameRef = doc(db, 'games', gameId);
        await updateDoc(gameRef, {
          status: 'playing',
          players: [existingGame.players[0], user.uid], // Player 'O'
          playerNames: {
            ...existingGame.playerNames,
            [user.uid]: userProfile.displayName || 'Player 2'
          }
        });
        onJoinGame(gameId);
      } catch (err) {
        console.error("Error joining game:", err);
      }
      setLoading(false);
    }

    return React.createElement('div', { className: 'card p-6' },
      React.createElement('h2', { className: 'text-2xl font-bold text-center mb-6' }, t('gameLobby')),
      React.createElement('button', {
        className: 'btn-primary w-full py-3 rounded-lg font-semibold',
        onClick: createGame,
        disabled: loading
      }, loading ? t('creating') : t('createGame')),
      React.createElement('hr', { className: 'my-6' }),
      React.createElement('h3', { className: 'text-xl font-bold mb-4' }, t('openGames')),
      React.createElement('div', { className: 'space-y-3' },
        openGames.length === 0 && React.createElement('div', { className: 'empty-state', style: { padding: '20px 0'} }, 
          React.createElement('div', { className: 'empty-icon' }, 'üéÆ'),
          React.createElement('div', null, t('noOpenGames'))
        ),
        openGames.map(game =>
          React.createElement('div', {
            key: game.id,
            className: 'flex justify-between items-center p-3 card rounded-lg shadow-sm'
          },
            React.createElement('span', null, t('gameBy', { name: game.playerNames[game.players[0]] })),
            // Don't show Join button for your own game
            game.players[0] !== user.uid && React.createElement('button', {
              className: 'btn-secondary px-4 py-2 rounded-lg font-semibold',
              onClick: () => joinGame(game.id, game),
              disabled: loading
            }, t('join'))
          )
        )
      )
    );
  }

  // New Component: Tic-Tac-Toe Game Window
  function TicTacToeGame({ t, user, gameId, onLeaveGame }) {
    const [game, setGame] = useState(null);
    const [loading, setLoading] = useState(true);

    useEffect(() => {
      const gameRef = doc(db, 'games', gameId);
      const unsubscribe = onSnapshot(gameRef, (doc) => {
        if (doc.exists()) {
          setGame({ id: doc.id, ...doc.data() });
        } else {
          onLeaveGame();
        }
        setLoading(false);
      });
      return () => unsubscribe();
    }, [gameId, onLeaveGame]);

    async function makeMove(index) {
      if (!game || game.status !== 'playing' || game.nextTurn !== user.uid || game.board[index]) {
        return; // Not your turn, game over, or cell taken
      }
      
      const newBoard = [...game.board];
      const playerSymbol = game.players[0] === user.uid ? 'X' : 'O';
      newBoard[index] = playerSymbol;

      const winner = checkWinner(newBoard);
      const newStatus = winner ? 'finished' : 'playing';
      const nextTurn = game.players.find(p => p !== user.uid);

      try {
        const gameRef = doc(db, 'games', gameId);
        await updateDoc(gameRef, {
          board: newBoard,
          status: newStatus,
          nextTurn: newStatus === 'finished' ? null : nextTurn,
          winner: winner
        });
      } catch (err) {
        console.error("Error making move:", err);
      }
    }

    if (loading || !game) {
      return React.createElement('div', { className: 'card p-6' }, t('loading'));
    }

    const playerSymbol = game.players[0] === user.uid ? 'X' : 'O';
    const opponentId = game.players.find(p => p !== user.uid);
    const opponentName = opponentId ? (game.playerNames[opponentId] || 'Player 2') : t('waiting');
    const isMyTurn = game.nextTurn === user.uid && game.status === 'playing';

    let statusMessage;
    if (game.status === 'waiting') {
      statusMessage = t('waitingForOpponent');
    } else if (game.status === 'playing') {
      statusMessage = isMyTurn ? t('yourTurn') : t('waitingFor', { name: opponentName });
    } else if (game.status === 'finished') {
      if (game.winner === 'T') {
        statusMessage = t('gameTie');
      } else if (game.winner === playerSymbol) {
        statusMessage = t('youWin');
      } else {
        statusMessage = t('youLose');
      }
    }

    return React.createElement('div', { className: 'card p-6 flex flex-col items-center' },
      React.createElement('h2', { className: 'text-2xl font-bold mb-4' }, 'Tic-Tac-Toe'),
      React.createElement('div', { className: 'mb-4 text-lg font-semibold' }, statusMessage),
      React.createElement('div', { className: 'game-board' },
        game.board.map((cell, index) =>
          React.createElement('div', {
            key: index,
            className: 'game-cell',
            onClick: () => makeMove(index),
            style: { cursor: isMyTurn && !cell ? 'pointer' : 'not-allowed' }
          }, cell)
        )
      ),
      (game.status === 'finished' || game.status === 'waiting') &&
        React.createElement('button', {
          className: 'btn-secondary w-full py-3 rounded-lg font-semibold mt-6',
          onClick: onLeaveGame
        }, game.status === 'waiting' ? t('cancelGame') : t('backToLobby'))
    );
  }

  // --- END OF NEW GAME CODE ---
  const container = document.getElementById('root');
  createRoot(container).render(React.createElement(App));

  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('sw.js').catch(err => console.log('SW failed', err));
    });
  }
  </script>
</body>
</html>
